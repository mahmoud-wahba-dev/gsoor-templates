<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <title>تحليل نتائج مادة لصف واحد | نماذج تعليمية</title>

    <style>
      body {
        font-family: "Helvetica", "Tajawal", sans-serif;
        background: #f8fafc;
        padding-top: 100px;
      }
      label {
        font-weight: 600;
        color: #136f3c;
        display: block;
        margin-bottom: 8px;
      }

      
.footer-ink {
        background: #f8fafb;
      }

      .social-icon {
        width: 26px;
        height: 26px;
        fill: currentColor;
      }


      input[type="text"],
      input[type="number"],
      input[type="date"],
      select,
      textarea {
        width: 100%;
        padding: 12px;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        background-color: #ffffff;
        font-size: 14px;
      }
      textarea {
        min-height: 80px;
        line-height: 1.8;
        font-size: 14px;
        padding: 12px;
        resize: vertical;
      }
      input[type="file"] {
        width: 100%;
        padding: 8px;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        background-color: #ffffff;
      }
      .section-bg {
        background-color: #f3f4f6;
        padding: 16px;
        border-radius: 8px;
        margin-bottom: 16px;
        border-right: 4px solid #3b82f6;
      }
      .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.7);
        z-index: 1000;
        overflow-y: auto;
        padding: 20px;
      }
      .modal-overlay.active {
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .modal-content {
        background: white;
        border-radius: 16px;
        max-width: 90%;
        width: 100%;
        max-width: 1200px;
        position: relative;
        margin: auto;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      }
      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px;
        border-bottom: 1px solid #e5e7eb;
      }
      .modal-body {
        padding: 20px;
        max-height: calc(100vh - 200px);
        overflow-y: auto;
      }
      .modal-close {
        background: none;
        border: none;
        font-size: 28px;
        cursor: pointer;
        color: #6b7280;
        padding: 0;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: all 0.2s;
      }
      .modal-close:hover {
        background-color: #f3f4f6;
        color: #111827;
      }
      .preview-template {
        background: white;
        padding: 40px;
        border: 2px solid #e5e7eb;
        border-radius: 12px;
      }
      .error-message {
        color: #dc2626;
        font-size: 14px;
        margin-top: 4px;
        display: none;
      }
      .error-message.show {
        display: block;
      }
      .field-error {
        border-color: #dc2626 !important;
        border-width: 2px !important;
      }
      .radio-group {
        display: flex;
        gap: 16px;
        margin-top: 8px;
      }
      .radio-option {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .radio-option input[type="radio"] {
        width: 18px;
        height: 18px;
      }
      .file-upload {
        position: relative;
        overflow: hidden;
        display: inline-block;
        width: 100%;
      }
      .file-upload-btn {
        border: 1px solid #d1d5db;
        border-radius: 6px;
        padding: 8px 16px;
        background-color: #f9fafb;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      .file-upload input[type="file"] {
        position: absolute;
        left: 0;
        top: 0;
        opacity: 0;
        cursor: pointer;
        width: 100%;
        height: 100%;
      }
      .student-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
      }
      .student-table th, .student-table td {
        border: 1px solid #d1d5db;
        padding: 8px;
        text-align: center;
      }
      .student-table th {
        background-color: #f3f4f6;
        font-weight: 600;
      }
      .add-student-btn {
        background-color: #10b981;
        color: white;
        border: none;
        border-radius: 6px;
        padding: 8px 16px;
        cursor: pointer;
        margin-top: 10px;
      }
      .remove-student-btn {
        background-color: #ef4444;
        color: white;
        border: none;
        border-radius: 6px;
        padding: 4px 8px;
        cursor: pointer;
      }
    </style>
</head>

<body class="bg-gray-100 py-10">
    <!-- NAVBAR WITHOUT CART -->
<header class="fixed inset-x-0 top-4 z-50 px-4 sm:px-6">
  <div class="max-w-6xl mx-auto relative">
    <div class="nav-pill px-3 py-2 flex items-center justify-between gap-3">
      <!-- LOGO -->
      <div class="flex items-center gap-4 ml-2">
        <a href="#" class="shrink-0">
          <img
            src="../assets/imgs/gsoor_logo.jpg"
            alt="logo"
            class="h-9 w-auto object-contain md:h-10"
          />
        </a>
      </div>

      <!-- NAV LINKS (desktop) -->
      <nav class="hidden md:flex items-center gap-8 text-sm text-gray-700">
        <a href="#" class="hover:text-cyan-600 transition">الشهادات</a>
        <a href="#" class="hover:text-cyan-600 transition">الملفات الإدارية</a>
        <a href="#" class="hover:text-cyan-600 transition">البطاقات</a>
      </nav>

      <!-- UTILITY ICONS WITHOUT CART -->
      <div class="flex items-center gap-2">
        <div class="hidden sm:flex items-center bg-gray-50 rounded-full px-2 py-1 gap-2 border border-gray-100">
          <button id="themeToggle" class="text-gray-600" title="تبديل الوضع">
            <i class="fa-solid fa-moon text-gray-600 text-base"></i>
          </button>
          <button id="profileBtn" class="text-gray-600" title="الحساب">
            <i class="fa-regular fa-user text-gray-600 text-base"></i>
          </button>
        </div>

        <!-- MOBILE MENU BUTTON -->
        <button id="menuBtn" class="md:hidden text-gray-600 p-2" aria-expanded="false">
          <i class="fa-solid fa-bars text-lg"></i>
        </button>
      </div>
    </div>

    <!-- MOBILE NAV WITHOUT CART -->
    <div id="mobileNav" class="hidden mobile-nav-abs mt-2 bg-white rounded-2xl shadow-md p-3 mx-4">
      <div class="flex flex-col gap-2 text-right">
        <a href="#" class="py-2 px-3 rounded hover:bg-gray-50 transition">الشهادات</a>
        <a href="#" class="py-2 px-3 rounded hover:bg-gray-50 transition">الملفات الإدارية</a>
        <a href="#" class="py-2 px-3 rounded hover:bg-gray-50 transition">البطاقات</a>
        <div class="pt-2 border-t border-gray-100 mt-2 flex justify-between items-center">
          <div class="flex items-center gap-3">
            <button id="mobileThemeToggle" class="text-gray-600">
              <i class="fa-solid fa-moon"></i>
            </button>
          </div>
          <a href="#" class="text-sm text-cyan-600 font-semibold">تسجيل دخول</a>
        </div>
      </div>
    </div>
  </div>
</header>
<script>
  // NAVBAR FUNCTIONALITY WITHOUT CART
  document.addEventListener('DOMContentLoaded', function() {
    const menuBtn = document.getElementById("menuBtn");
    const mobileNav = document.getElementById("mobileNav");
    const mobileThemeToggle = document.getElementById("mobileThemeToggle");

    // Mobile menu toggle
    if (menuBtn) {
      menuBtn.addEventListener("click", (e) => {
        const expanded = menuBtn.getAttribute("aria-expanded") === "true";
        menuBtn.setAttribute("aria-expanded", String(!expanded));
        mobileNav.classList.toggle("hidden");
      });
    }

    // Close mobile menu when clicking outside
    document.addEventListener("click", (e) => {
      if (!mobileNav || mobileNav.classList.contains("hidden")) return;
      const path = e.composedPath?.() || e.path || [];
      if (!path.includes(mobileNav) && !path.includes(menuBtn)) {
        mobileNav.classList.add("hidden");
        if (menuBtn) menuBtn.setAttribute("aria-expanded", "false");
      }
    });

    // Close mobile menu on window resize
    window.addEventListener("resize", () => {
      if (window.innerWidth >= 768) {
        mobileNav.classList.add("hidden");
        if (menuBtn) menuBtn.setAttribute("aria-expanded", "false");
      }
    });

    // Theme toggle
    document.getElementById("themeToggle")?.addEventListener("click", () => {
      document.documentElement.classList.toggle("dark");
    });
    
    if (mobileThemeToggle) {
      mobileThemeToggle.addEventListener("click", () => {
        document.documentElement.classList.toggle("dark");
      });
    }
  });
</script>
    <div class="max-w-6xl mx-auto">
        <div class="max-w-4xl mx-auto border-4 rounded-2xl shadow-xl overflow-hidden mb-8 p-4 bg-white">
            <div class="text-center mb-8">
                <h1 class="text-4xl font-bold text-gray-800 mb-4">تحليل نتائج مادة لصف واحد</h1>
                <p class="text-gray-600 text-lg">
                    إنشاء وتخصيص تحليل نتائج مادة لصف واحد مع إمكانية تحرير وإضافة جميع البيانات الخاصة بك، بطريقة سهلة واحترافية توفر عليه الوقت والجهد ويتم حفظ الملف النهائي بتنسيق صورة أو ملف pdf لسهولة الطباعة بجودة عالية وإعادة الاستخدام في تقارير ونماذج أخرى.
                </p>
            </div>

            <div class="p-6 space-y-6">
                <!-- المعلومات الأساسية -->
                <div class="section-bg">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">المعلومات الأساسية</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="mb-2">اسم المدرسة:</label>
                            <input type="text" id="schoolName" placeholder="اسم المدرسة" class="w-full">
                        </div>
                        <div>
                            <label class="mb-2">الفصل الدراسي:</label>
                            <select id="semester" class="w-full">
                                <option value="">اختر الفصل الدراسي</option>
                                <option value="first">الفصل الأول</option>
                                <option value="second">الفصل الثاني</option>
                            </select>
                        </div>
                        <div>
                            <label class="mb-2">العام الدراسي:</label>
                            <input type="text" id="academicYear" placeholder="١٤٤٦ - ١٤٤٧" class="w-full">
                        </div>
                        <div>
                            <label class="mb-2">اسم المادة:</label>
                            <input type="text" id="subjectName" placeholder="اسم المادة" class="w-full">
                        </div>
                        <div>
                            <label class="mb-2">اسم المعلم:</label>
                            <input type="text" id="teacherName" placeholder="اسم المعلم" class="w-full">
                        </div>
                        <div>
                            <label class="mb-2">الصف:</label>
                            <input type="text" id="classLevel" placeholder="الصف الأول ثانوي" class="w-full">
                        </div>
                    </div>
                </div>

                <!-- بيانات الطلاب والنتائج -->
                <div class="section-bg">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">بيانات الطلاب والنتائج</h3>
                    <table class="student-table">
                        <thead>
                            <tr>
                                <th>م</th>
                                <th>اسم الطالب</th>
                                <th>الاختبار الأول</th>
                                <th>الاختبار الثاني</th>
                                <th>الاختبار النهائي</th>
                                <th>المشاريع</th>
                                <th>المشاركة</th>
                                <th>المجموع</th>
                                <th>التقدير</th>
                                <th>حذف</th>
                            </tr>
                        </thead>
                        <tbody id="studentsTableBody">
                            <!-- سيتم إضافة الصفوف ديناميكياً -->
                        </tbody>
                    </table>
                    <button type="button" id="addStudentBtn" class="add-student-btn">
                        <i class="fas fa-plus ml-2"></i>إضافة طالب
                    </button>
                </div>

                <!-- التحليل الإحصائي -->
                <div class="section-bg">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">التحليل الإحصائي</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="mb-2">عدد الطلاب:</label>
                            <input type="number" id="totalStudents" placeholder="0" class="w-full" readonly>
                        </div>
                        <div>
                            <label class="mb-2">متوسط الدرجات:</label>
                            <input type="number" id="averageScore" placeholder="0" class="w-full" readonly>
                        </div>
                        <div>
                            <label class="mb-2">أعلى درجة:</label>
                            <input type="number" id="highestScore" placeholder="0" class="w-full" readonly>
                        </div>
                        <div>
                            <label class="mb-2">أقل درجة:</label>
                            <input type="number" id="lowestScore" placeholder="0" class="w-full" readonly>
                        </div>
                        <div>
                            <label class="mb-2">نسبة النجاح:</label>
                            <input type="text" id="successRate" placeholder="0%" class="w-full" readonly>
                        </div>
                        <div>
                            <label class="mb-2">عدد الناجحين:</label>
                            <input type="number" id="passedStudents" placeholder="0" class="w-full" readonly>
                        </div>
                    </div>
                </div>

                <!-- التوزيع التكراري -->
                <div class="section-bg">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">التوزيع التكراري للدرجات</h3>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div>
                            <label class="mb-2">ممتاز (90-100):</label>
                            <input type="number" id="excellentCount" placeholder="0" class="w-full" readonly>
                        </div>
                        <div>
                            <label class="mb-2">جيد جداً (80-89):</label>
                            <input type="number" id="veryGoodCount" placeholder="0" class="w-full" readonly>
                        </div>
                        <div>
                            <label class="mb-2">جيد (70-79):</label>
                            <input type="number" id="goodCount" placeholder="0" class="w-full" readonly>
                        </div>
                        <div>
                            <label class="mb-2">مقبول (60-69):</label>
                            <input type="number" id="acceptableCount" placeholder="0" class="w-full" readonly>
                        </div>
                    </div>
                </div>

                <!-- الملاحظات والتوصيات -->
                <div class="section-bg">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">الملاحظات والتوصيات</h3>
                    <div>
                        <label class="mb-2">الملاحظات العامة:</label>
                        <textarea id="generalNotes" placeholder="اكتب الملاحظات العامة حول نتائج الطلاب..." class="w-full"></textarea>
                    </div>
                    <div class="mt-4">
                        <label class="mb-2">التوصيات:</label>
                        <textarea id="recommendations" placeholder="اكتب التوصيات لتحسين مستوى الطلاب..." class="w-full"></textarea>
                    </div>
                </div>

                <!-- توقيع المعلم -->
                <div class="section-bg">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">توقيع المعلم</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="mb-2">اسم المعلم:</label>
                            <input type="text" id="teacherSignatureName" placeholder="اسم المعلم" class="w-full">
                        </div>
                        <div>
                            <label class="mb-2">التوقيع:</label>
                            <input type="text" id="teacherSignature" placeholder="التوقيع" class="w-full">
                        </div>
                    </div>
                </div>

                <!-- تخصيص التصميم -->
                <div class="section-bg">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">تخصيص التصميم</h3>
                    
                    <div class="mb-4">
                        <label class="mb-2">ستايل النموذج:</label>
                        <div class="radio-group">
                            <div class="radio-option">
                                <input type="radio" id="style1" name="templateStyle" value="white" checked>
                                <label for="style1">أبيض (توفير حبر)</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="style2" name="templateStyle" value="original">
                                <label for="style2">الهوية البصرية الأصلية</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="style3" name="templateStyle" value="gradient">
                                <label for="style3">الهوية البصرية تدرج</label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <label class="mb-2">شعار الجهة:</label>
                        <div class="file-upload">
                            <div class="file-upload-btn">
                                <span>شعار وزارة التعليم السعودية</span>
                                <span>No file chosen</span>
                            </div>
                            <input type="file" id="mainLogo" accept="image/*">
                        </div>
                        <p class="text-gray-600 text-sm mt-2">اختياري - سيظهر شعار وزارة التعليم افتراضياً</p>
                    </div>
                    
                    <div class="mb-4">
                        <label class="mb-2">استخدام الأرقام العربية:</label>
                        <div class="radio-group">
                            <div class="radio-option">
                                <input type="radio" id="arabicNumbersOn" name="arabicNumbers" value="on" checked>
                                <label for="arabicNumbersOn">مفعل</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="arabicNumbersOff" name="arabicNumbers" value="off">
                                <label for="arabicNumbersOff">معطل</label>
                            </div>
                        </div>
                        <p class="text-gray-600 text-sm mt-2">عند الإيقاف تظهر الأرقام كما أدخلت</p>
                    </div>
                </div>

                <!-- زر المعاينة -->
                <div class="flex justify-center mt-8">
                    <button onclick="previewTemplate()" class="bg-green-600 text-white px-8 py-4 rounded-lg font-bold text-lg flex items-center gap-3 hover:bg-green-700 transition">
                        <i class="fas fa-eye ml-2"></i>
                        معاينة التقرير
                    </button>
                </div>
            </div>
        </div>
    </div>

<!-- FOOTER -->
    <footer class="mt-12 footer-ink border-t border-gray-100">
      <div
        class="max-w-6xl mx-auto px-6 py-8 flex flex-col md:flex-row md:items-center md:justify-between gap-6"
      >
        <!-- RIGHT COLUMN -->
        <div class="text-right md:flex-1">
          <img
            src="../assets/imgs/gsoor_logo.jpg"
            alt="logo"
            class="h-10 mx-auto md:mx-0"
          />
          <div
            class="flex justify-center md:justify-end gap-4 mt-3 text-gray-600"
          >
            <i class="fa-brands fa-youtube social-icon text-lg"></i>
            <i class="fa-brands fa-tiktok social-icon text-lg"></i>
            <i class="fa-brands fa-instagram social-icon text-lg"></i>
          </div>
        </div>

        <!-- CENTER COLUMN -->
        <div class="text-center md:flex-1">
          <h3 class="font-bold mb-2">تواصل معنا</h3>
          <div class="flex items-center justify-center gap-4 text-gray-600">
            <div class="flex items-center gap-2">
              <i class="fa-regular fa-envelope text-sm"></i>
              <span>البريد</span>
            </div>
            <div class="flex items-center gap-2">
              <i class="fa-solid fa-mobile-screen-button text-sm"></i>
              <span>واتس</span>
            </div>
          </div>
          <div class="mt-3 text-sm text-gray-500">موقّع لدى منصة الأعمال</div>
        </div>

        <!-- LEFT COLUMN -->
        <div class="text-left md:flex-1">
          <div class="text-sm text-gray-500">
            © 2025 متجر جسور الرقمي | جميع الحقوق محفوظة
          </div>
          <div
            class="mt-3 flex gap-2 items-center justify-center md:justify-start"
          >
            <span class="sr-only">Visa</span>
            <i class="fa-brands fa-cc-visa text-gray-600 text-lg"></i>
            <span class="sr-only">Mada</span>
            <i class="fa-solid fa-credit-card text-gray-600 text-lg"></i>
          </div>
        </div>
      </div>
    </footer>
    <!-- Modal Popup للمعاينة -->
    <div id="previewModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="text-2xl font-bold text-gray-800">معاينة تحليل النتائج</h2>
                <button class="modal-close" onclick="closePreviewModal()">
                    &times;
                </button>
            </div>
            <div class="modal-body">
                <div id="previewTemplateContent" class="preview-template">
                    <!-- سيتم ملء المحتوى ديناميكياً -->
                </div>
                <div class="flex justify-center gap-4 mt-6">
                    <button onclick="downloadImageFromModal()" class="bg-blue-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-blue-700 transition flex items-center gap-2">
                        <i class="fas fa-download ml-2"></i>
                        تحميل كصورة
                    </button>
                    <button onclick="downloadPDFFromModal()" class="bg-red-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-red-700 transition flex items-center gap-2">
                        <i class="fas fa-file-pdf ml-2"></i>
                        تحميل PDF
                    </button>
                    <button onclick="closePreviewModal()" class="bg-gray-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-gray-700 transition">
                        إغلاق
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // متغير لحساب عدد الطلاب
        let studentCounter = 0;

        // إضافة طالب جديد
        document.getElementById('addStudentBtn').addEventListener('click', function() {
            addStudentRow();
        });

        function addStudentRow(name = '', test1 = '', test2 = '', final = '', projects = '', participation = '') {
            studentCounter++;
            const tbody = document.getElementById('studentsTableBody');
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${studentCounter}</td>
                <td><input type="text" class="student-name w-full border-none bg-transparent" value="${name}" placeholder="اسم الطالب"></td>
                <td><input type="number" class="test1 w-full border-none bg-transparent" value="${test1}" min="0" max="20" placeholder="0-20"></td>
                <td><input type="number" class="test2 w-full border-none bg-transparent" value="${test2}" min="0" max="20" placeholder="0-20"></td>
                <td><input type="number" class="final w-full border-none bg-transparent" value="${final}" min="0" max="40" placeholder="0-40"></td>
                <td><input type="number" class="projects w-full border-none bg-transparent" value="${projects}" min="0" max="10" placeholder="0-10"></td>
                <td><input type="number" class="participation w-full border-none bg-transparent" value="${participation}" min="0" max="10" placeholder="0-10"></td>
                <td><input type="number" class="total w-full border-none bg-transparent" readonly></td>
                <td><input type="text" class="grade w-full border-none bg-transparent" readonly></td>
                <td><button type="button" class="remove-student-btn"><i class="fas fa-trash"></i></button></td>
            `;
            tbody.appendChild(row);

            // إضافة حدث لحذف الطالب
            row.querySelector('.remove-student-btn').addEventListener('click', function() {
                row.remove();
                updateStatistics();
            });

            // إضافة أحداث لحساب المجموع والتقدير
            const inputs = row.querySelectorAll('input[type="number"]');
            inputs.forEach(input => {
                input.addEventListener('input', function() {
                    calculateStudentTotal(row);
                    updateStatistics();
                });
            });

            // حساب القيم الأولية
            calculateStudentTotal(row);
            updateStatistics();
        }

        // حساب مجموع الطالب وتقديره
        function calculateStudentTotal(row) {
            const test1 = parseFloat(row.querySelector('.test1').value) || 0;
            const test2 = parseFloat(row.querySelector('.test2').value) || 0;
            const final = parseFloat(row.querySelector('.final').value) || 0;
            const projects = parseFloat(row.querySelector('.projects').value) || 0;
            const participation = parseFloat(row.querySelector('.participation').value) || 0;
            
            const total = test1 + test2 + final + projects + participation;
            row.querySelector('.total').value = total;

            // حساب التقدير
            let grade = '';
            if (total >= 90) grade = 'ممتاز';
            else if (total >= 80) grade = 'جيد جداً';
            else if (total >= 70) grade = 'جيد';
            else if (total >= 60) grade = 'مقبول';
            else grade = 'راسب';

            row.querySelector('.grade').value = grade;
        }

        // تحديث الإحصائيات
        function updateStatistics() {
            const students = document.querySelectorAll('#studentsTableBody tr');
            const totals = [];
            let passedCount = 0;
            let excellentCount = 0;
            let veryGoodCount = 0;
            let goodCount = 0;
            let acceptableCount = 0;

            students.forEach(row => {
                const total = parseFloat(row.querySelector('.total').value) || 0;
                totals.push(total);

                if (total >= 60) passedCount++;

                if (total >= 90) excellentCount++;
                else if (total >= 80) veryGoodCount++;
                else if (total >= 70) goodCount++;
                else if (total >= 60) acceptableCount++;
            });

            // تحديث الإحصائيات
            document.getElementById('totalStudents').value = students.length;
            document.getElementById('passedStudents').value = passedCount;
            document.getElementById('excellentCount').value = excellentCount;
            document.getElementById('veryGoodCount').value = veryGoodCount;
            document.getElementById('goodCount').value = goodCount;
            document.getElementById('acceptableCount').value = acceptableCount;

            if (totals.length > 0) {
                const average = totals.reduce((a, b) => a + b, 0) / totals.length;
                const highest = Math.max(...totals);
                const lowest = Math.min(...totals);
                const successRate = (passedCount / students.length) * 100;

                document.getElementById('averageScore').value = average.toFixed(2);
                document.getElementById('highestScore').value = highest;
                document.getElementById('lowestScore').value = lowest;
                document.getElementById('successRate').value = successRate.toFixed(1) + '%';
            } else {
                document.getElementById('averageScore').value = '0';
                document.getElementById('highestScore').value = '0';
                document.getElementById('lowestScore').value = '0';
                document.getElementById('successRate').value = '0%';
            }
        }

        // إضافة بعض الطلاب الافتراضيين للاختبار
        document.addEventListener('DOMContentLoaded', function() {
            addStudentRow('أحمد محمد', 18, 17, 35, 8, 9);
            addStudentRow('فاطمة عبدالله', 20, 19, 38, 9, 10);
            addStudentRow('خالد إبراهيم', 15, 16, 32, 7, 8);
        });

        // دالة المعاينة
        function previewTemplate() {
            generatePreviewContent();
            openPreviewModal();
        }

        // فتح الـ modal
        function openPreviewModal() {
            const modal = document.getElementById('previewModal');
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        // إغلاق الـ modal
        function closePreviewModal() {
            const modal = document.getElementById('previewModal');
            modal.classList.remove('active');
            document.body.style.overflow = 'auto';
        }

        // توليد محتوى المعاينة
        function generatePreviewContent() {
            const data = collectFormData();
            const previewContainer = document.getElementById('previewTemplateContent');

            let html = `
                <div class="space-y-6 text-right">
                    <div class="text-center mb-6 border-b pb-4">
                        <h1 class="text-3xl font-bold text-green-800 mb-2">تحليل نتائج ${data.subjectName || 'المادة'}</h1>
                        <p class="text-lg text-gray-700">${data.schoolName || 'المدرسة'} - ${data.classLevel || 'الصف'} - ${data.academicYear || 'العام الدراسي'}</p>
                    </div>

                    <div class="mb-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">التحليل الإحصائي</h3>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div class="text-center p-4 bg-blue-50 rounded-lg">
                                <p class="text-2xl font-bold text-blue-700">${data.totalStudents}</p>
                                <p class="text-gray-600">عدد الطلاب</p>
                            </div>
                            <div class="text-center p-4 bg-green-50 rounded-lg">
                                <p class="text-2xl font-bold text-green-700">${data.averageScore}</p>
                                <p class="text-gray-600">متوسط الدرجات</p>
                            </div>
                            <div class="text-center p-4 bg-yellow-50 rounded-lg">
                                <p class="text-2xl font-bold text-yellow-700">${data.successRate}</p>
                                <p class="text-gray-600">نسبة النجاح</p>
                            </div>
                            <div class="text-center p-4 bg-red-50 rounded-lg">
                                <p class="text-2xl font-bold text-red-700">${data.passedStudents}</p>
                                <p class="text-gray-600">عدد الناجحين</p>
                            </div>
                        </div>
                    </div>

                    <div class="mb-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">التوزيع التكراري</h3>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div class="text-center p-3 bg-purple-50 rounded">
                                <p class="text-lg font-bold text-purple-700">${data.excellentCount}</p>
                                <p class="text-gray-600">ممتاز</p>
                            </div>
                            <div class="text-center p-3 bg-indigo-50 rounded">
                                <p class="text-lg font-bold text-indigo-700">${data.veryGoodCount}</p>
                                <p class="text-gray-600">جيد جداً</p>
                            </div>
                            <div class="text-center p-3 bg-blue-50 rounded">
                                <p class="text-lg font-bold text-blue-700">${data.goodCount}</p>
                                <p class="text-gray-600">جيد</p>
                            </div>
                            <div class="text-center p-3 bg-cyan-50 rounded">
                                <p class="text-lg font-bold text-cyan-700">${data.acceptableCount}</p>
                                <p class="text-gray-600">مقبول</p>
                            </div>
                        </div>
                    </div>
            `;

            // إضافة جدول الطلاب إذا كان هناك طلاب
            if (data.students && data.students.length > 0) {
                html += `
                    <div class="mb-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">نتائج الطلاب</h3>
                        <div class="overflow-x-auto">
                            <table class="w-full border-collapse border border-gray-300">
                                <thead>
                                    <tr class="bg-gray-100">
                                        <th class="border border-gray-300 p-2">م</th>
                                        <th class="border border-gray-300 p-2">اسم الطالب</th>
                                        <th class="border border-gray-300 p-2">الاختبار الأول</th>
                                        <th class="border border-gray-300 p-2">الاختبار الثاني</th>
                                        <th class="border border-gray-300 p-2">النهائي</th>
                                        <th class="border border-gray-300 p-2">المشاريع</th>
                                        <th class="border border-gray-300 p-2">المشاركة</th>
                                        <th class="border border-gray-300 p-2">المجموع</th>
                                        <th class="border border-gray-300 p-2">التقدير</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;

                data.students.forEach((student, index) => {
                    html += `
                        <tr>
                            <td class="border border-gray-300 p-2">${index + 1}</td>
                            <td class="border border-gray-300 p-2">${student.name}</td>
                            <td class="border border-gray-300 p-2">${student.test1}</td>
                            <td class="border border-gray-300 p-2">${student.test2}</td>
                            <td class="border border-gray-300 p-2">${student.final}</td>
                            <td class="border border-gray-300 p-2">${student.projects}</td>
                            <td class="border border-gray-300 p-2">${student.participation}</td>
                            <td class="border border-gray-300 p-2">${student.total}</td>
                            <td class="border border-gray-300 p-2">${student.grade}</td>
                        </tr>
                    `;
                });

                html += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            }

            // إضافة الملاحظات والتوقيع
            html += `
                <div class="mb-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">الملاحظات والتوصيات</h3>
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <p class="text-gray-700 mb-4"><strong>الملاحظات العامة:</strong><br>${data.generalNotes || 'لا توجد ملاحظات'}</p>
                        <p class="text-gray-700"><strong>التوصيات:</strong><br>${data.recommendations || 'لا توجد توصيات'}</p>
                    </div>
                </div>

                <div class="mt-8 pt-4 border-t border-gray-300">
                    <div class="flex justify-between items-center">
                        <div class="text-center">
                            <p class="text-lg font-bold">${data.teacherSignatureName || 'اسم المعلم'}</p>
                            <p class="text-gray-600">توقيع المعلم</p>
                        </div>
                        <div class="text-gray-500 text-sm">
                            <p>تم الإنشاء في: ${new Date().toLocaleDateString('ar-SA')}</p>
                        </div>
                    </div>
                </div>
            </div>
            `;

            previewContainer.innerHTML = html;
        }

        // جمع البيانات من النموذج
        function collectFormData() {
            const students = [];
            document.querySelectorAll('#studentsTableBody tr').forEach(row => {
                students.push({
                    name: row.querySelector('.student-name').value,
                    test1: row.querySelector('.test1').value,
                    test2: row.querySelector('.test2').value,
                    final: row.querySelector('.final').value,
                    projects: row.querySelector('.projects').value,
                    participation: row.querySelector('.participation').value,
                    total: row.querySelector('.total').value,
                    grade: row.querySelector('.grade').value
                });
            });

            return {
                schoolName: document.getElementById('schoolName').value,
                semester: document.getElementById('semester').value,
                academicYear: document.getElementById('academicYear').value,
                subjectName: document.getElementById('subjectName').value,
                teacherName: document.getElementById('teacherName').value,
                classLevel: document.getElementById('classLevel').value,
                totalStudents: document.getElementById('totalStudents').value,
                averageScore: document.getElementById('averageScore').value,
                highestScore: document.getElementById('highestScore').value,
                lowestScore: document.getElementById('lowestScore').value,
                successRate: document.getElementById('successRate').value,
                passedStudents: document.getElementById('passedStudents').value,
                excellentCount: document.getElementById('excellentCount').value,
                veryGoodCount: document.getElementById('veryGoodCount').value,
                goodCount: document.getElementById('goodCount').value,
                acceptableCount: document.getElementById('acceptableCount').value,
                generalNotes: document.getElementById('generalNotes').value,
                recommendations: document.getElementById('recommendations').value,
                teacherSignatureName: document.getElementById('teacherSignatureName').value,
                teacherSignature: document.getElementById('teacherSignature').value,
                students: students
            };
        }

        // تحميل الصورة من الـ modal
        function downloadImageFromModal() {
            const previewContent = document.getElementById('previewTemplateContent');
            html2canvas(previewContent, {
                backgroundColor: '#ffffff',
                scale: 2,
            }).then((canvas) => {
                const link = document.createElement('a');
                link.download = 'تحليل-النتائج.png';
                link.href = canvas.toDataURL();
                link.click();
            });
        }

        // تحميل PDF من الـ modal
        function downloadPDFFromModal() {
            const previewContent = document.getElementById('previewTemplateContent');
            html2canvas(previewContent, {
                backgroundColor: '#ffffff',
                scale: 2,
            }).then((canvas) => {
                const imgData = canvas.toDataURL('image/jpeg');
                const pdf = new jspdf.jsPDF('p', 'mm', 'a4');
                const imgWidth = 210;
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                pdf.addImage(imgData, 'JPEG', 0, 0, imgWidth, imgHeight);
                pdf.save('تحليل-النتائج.pdf');
            });
        }
    </script>
</body>
</html>
