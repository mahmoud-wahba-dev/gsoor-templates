<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>نموذج تنفيذ استراتيجية مختصرة</title>

  <!-- Add required libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer">

  <style>
    :root{
      --bg:#f6f8fa;
      --card:#fff;
      --accent:#2aa44f;
      --muted:#6b7280;
      --input:#f3f4f6;
      --switch-bg:#e6e7ee;
      --switch-on:#4f46e5;
      --error:#dc2626;
    }

    *{box-sizing:border-box;font-family:Tahoma,Arial, sans-serif}
    body{background:var(--bg);padding:24px;color:#111; margin: 0;}

    .container{max-width:920px;margin:0 auto}
    .card{
      background:var(--card);
      border-radius:12px;
      padding:22px 24px;
      box-shadow:0 6px 20px rgba(2,6,23,0.06)
    }

    h1{font-size:20px;margin:6px 0;text-align:center;}
    p.lead{color:var(--muted);font-size:14px;text-align:center;margin-bottom:18px}

    .top-img{
      display:flex;
      justify-content:center;
      margin-bottom:14px
    }
    .top-img img{
      width:130px;
      height:130px;
      border-radius:50%;
      object-fit:cover;
      border:6px solid #fff;
      box-shadow:0 4px 12px rgba(0,0,0,0.08)
    }

.footer-ink {
        background: #f8fafb;
      }

      .social-icon {
        width: 26px;
        height: 26px;
        fill: currentColor;
      }


    form .row{display:flex;gap:12px;margin-bottom:12px}
    form .col{flex:1}
    label{display:block;font-size:13px;margin-bottom:6px;color:#0f172a}
    input[type=text], textarea, select, input[type=date], input[type=file]{
      width:100%;
      padding:10px;
      border-radius:8px;
      border:1px solid #e6e9ee;
      background:var(--input);
      font-size:14px
    }
    textarea{min-height:100px;resize:vertical}

    .section{
      margin-top:18px;
      padding-top:14px;
      border-top:1px dashed #e6e9ee
    }

    .two-cols{display:flex;gap:12px}
    .two-cols>*{flex:1}

    .small{font-size:12px;color:var(--muted)}

    .actions{
      display:flex;
      gap:12px;
      align-items:center;
      margin-top:16px
    }

    .btn{
      padding:10px 18px;
      border-radius:8px;
      border:0;
      cursor:pointer;
      font-weight:600;
      transition: all 0.3s;
    }
    .btn.green{background:var(--accent);color:#fff}
    .btn.green:hover{background:#238c43;}
    .btn.ghost{background:transparent;border:1px solid #d1d5db}
    .btn.ghost:hover{background:#f9fafb;}

    /* Switch Styling */
    .toggle-item{
      display:flex;
      gap:10px;
      align-items:center;
      background:#fff;
      padding:8px 12px;
      border-radius:12px;
      border:1px solid rgba(15,23,42,0.06);
      min-width:170px;
      margin-bottom: 8px;
    }

    .switch{
      --w:44px;
      --h:24px;
      position:relative;
      width:var(--w);
      height:var(--h);
      background:var(--switch-bg);
      border-radius:999px;
      padding:3px;
      transition:.18s;
      display:inline-block;
    }

    .switch input{display:none;}

    .knob{
      position:absolute;
      top:3px;
      left:3px;
      width:18px;
      height:18px;
      background:white;
      border-radius:50%;
      box-shadow:0 2px 6px rgba(2,6,23,0.12);
      transition:.18s cubic-bezier(.2,.9,.3,1);
    }

    .switch input:checked + .knob{
      transform:translateX(20px);
    }

    .switch-bg-active{
      position:absolute;
      inset:0;
      border-radius:999px;
      pointer-events:none;
      background:#e6e7ee;
      transition:.18s;
    }

    .switch input:checked ~ .switch-bg-active{
      background:var(--switch-on);
      box-shadow:0 6px 18px rgba(79,70,229,0.18)
    }

    /* Error Styles */
    .error-message {
      color: var(--error);
      font-size: 11px;
      margin-top: 4px;
      display: none;
    }
    .error-message.show {
      display: block;
    }
    .field-error {
      border-color: var(--error) !important;
      border-width: 2px !important;
    }

    /* Modal Styles */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.7);
      z-index: 1000;
      overflow-y: auto;
      padding: 20px;
    }
    .modal-overlay.active {
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .modal-content {
      background: white;
      border-radius: 16px;
      max-width: 90%;
      width: 100%;
      max-width: 800px;
      position: relative;
      margin: auto;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px;
      border-bottom: 1px solid #e5e7eb;
    }
    .modal-body {
      padding: 20px;
      max-height: calc(100vh - 200px);
      overflow-y: auto;
    }
    .modal-close {
      background: none;
      border: none;
      font-size: 28px;
      cursor: pointer;
      color: #6b7280;
      padding: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: all 0.2s;
    }
    .modal-close:hover {
      background-color: #f3f4f6;
      color: #111827;
    }
    .preview-template {
      background: white;
      padding: 30px;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
    }

    /* Download Buttons */
    .download-buttons {
      display: flex;
      justify-content: center;
      gap: 12px;
      margin-top: 20px;
      flex-wrap: wrap;
    }
    .btn-download {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.3s;
    }
    .btn-download-pdf {
      background: #dc2626;
      color: white;
    }
    .btn-download-pdf:hover {
      background: #b91c1c;
    }
    .btn-download-image {
      background: #2563eb;
      color: white;
    }
    .btn-download-image:hover {
      background: #1d4ed8;
    }
    .btn-close {
      background: #6b7280;
      color: white;
    }
    .btn-close:hover {
      background: #4b5563;
    }

    @media (max-width:720px){
      form .row, .two-cols{flex-direction:column}
      .toggle-item{min-width:100%}
      .top-img img{width:95px;height:95px}
      .download-buttons {
        flex-direction: column;
        align-items: center;
      }
      .btn-download {
        width: 200px;
        justify-content: center;
      }
    }
  </style>
</head>

<body>

<div class="container">
  <div class="card">

    <!-- Image -->
    <div class="top-img">
      <img src="your-image.png" alt="صورة النموذج">
    </div>

    <h1>نموذج تنفيذ استراتيجية مختصرة</h1>
    <p class="lead">
      إنشاء وتخصيص نموذج تنفيذ استراتيجية مختصرة مع إمكانية تحرير وإضافة جميع البيانات الخاصة بك…
    </p>

    <form id="docForm">

      <!-- Fields -->
      <div class="row">
        <div class="col">
          <label>إدارة التعليم / المنطقة / مكتب التعليم</label>
          <input type="text" id="educationDept">
          <div id="educationDeptError" class="error-message">هذا الحقل مطلوب</div>
        </div>
      </div>

      <div class="row">
        <div class="col">
          <label>اسم المدرسة</label>
          <input type="text" id="schoolName">
          <div id="schoolNameError" class="error-message">هذا الحقل مطلوب</div>
        </div>

        <div class="col">
          <label>تاريخ التنفيذ</label>
          <input type="text" id="executionDate">
          <div id="executionDateError" class="error-message">هذا الحقل مطلوب</div>
        </div>
      </div>

      <div class="row">
        <div class="col">
          <label>المادة</label>
          <input type="text" id="subject">
          <div id="subjectError" class="error-message">هذا الحقل مطلوب</div>
        </div>
      </div>

      <div class="row">
        <div class="col">
          <label>استراتيجية التعلم</label>
          <input type="text" id="learningStrategy">
          <div id="learningStrategyError" class="error-message">هذا الحقل مطلوب</div>
        </div>
      </div>

      <div class="row">
        <div class="col">
          <label>عدد المستفيدين</label>
          <input type="text" id="beneficiariesCount">
          <div id="beneficiariesCountError" class="error-message">هذا الحقل مطلوب</div>
        </div>
      </div>

      <div class="row">
        <div class="col">
          <label>المرحلة الدراسية</label>
          <input type="text" id="educationStage">
          <div id="educationStageError" class="error-message">هذا الحقل مطلوب</div>
        </div>

        <div class="col">
          <label>الفصل</label>
          <input type="text" id="class">
          <div id="classError" class="error-message">هذا الحقل مطلوب</div>
        </div>
      </div>

      <div class="row">
        <div class="col">
          <label>اسم الدرس</label>
          <input type="text" id="lessonName">
          <div id="lessonNameError" class="error-message">هذا الحقل مطلوب</div>
        </div>
      </div>

      <!-- Goals -->
      <div class="section">
        <label>الأهداف</label>
        <textarea id="objectives"></textarea>
        <div id="objectivesError" class="error-message">هذا الحقل مطلوب</div>
      </div>

      <div class="section">
        <label>اسم المعلم</label>
        <textarea id="teacherName"></textarea>
        <div id="teacherNameError" class="error-message">هذا الحقل مطلوب</div>
      </div>

      <!-- Names -->
      <div class="section two-cols">
        <div>
          <label>اسم آخر</label>
          <input type="text" id="otherName">
          <div id="otherNameError" class="error-message">هذا الحقل مطلوب</div>
        </div>

        <div>
          <label>حساب تويتر</label>
          <input type="text" id="twitterAccount">
        </div>
      </div>

      <div class="section">
        <h2>الوسائل التعليمية المستخدمة:</h2>
        <p style="margin:0 0 8px 0; color:var(--muted)">فعّل/أوقف الوسائل التي تريد استخدامها.</p>

        <div class="controls" aria-live="polite">
          <!-- Toggle items -->
          <label class="toggle-item">
            <span class="label">جهاز عرض</span>
            <span style="margin-inline-start:auto;">
              <span class="switch" title="تبديل جهاز عرض">
                <input type="checkbox" id="proj" />
                <span class="knob" aria-hidden="true"></span>
                <span class="switch-bg-active" style="position:absolute; inset:0; border-radius:999px; pointer-events:none;"></span>
              </span>
            </span>
          </label>

          <label class="toggle-item">
            <span class="label">جهاز حاسب</span>
            <span style="margin-inline-start:auto;">
              <span class="switch">
                <input type="checkbox" id="pc" checked/>
                <span class="knob" aria-hidden="true"></span>
                <span class="switch-bg-active" style="position:absolute; inset:0; border-radius:999px; pointer-events:none;"></span>
              </span>
            </span>
          </label>

          <label class="toggle-item">
            <span class="label">صورة توضيحية</span>
            <span style="margin-inline-start:auto;">
              <span class="switch">
                <input type="checkbox" id="img" />
                <span class="knob" aria-hidden="true"></span>
                <span class="switch-bg-active" style="position:absolute; inset:0; border-radius:999px; pointer-events:none;"></span>
              </span>
            </span>
          </label>

          <label class="toggle-item">
            <span class="label">أدوات رياضية</span>
            <span style="margin-inline-start:auto;">
              <span class="switch">
                <input type="checkbox" id="sports" />
                <span class="knob" aria-hidden="true"></span>
                <span class="switch-bg-active" style="position:absolute; inset:0; border-radius:999px; pointer-events:none;"></span>
              </span>
            </span>
          </label>

          <label class="toggle-item">
            <span class="label">كتاب</span>
            <span style="margin-inline-start:auto;">
              <span class="switch">
                <input type="checkbox" id="book" />
                <span class="knob" aria-hidden="true"></span>
                <span class="switch-bg-active" style="position:absolute; inset:0; border-radius:999px; pointer-events:none;"></span>
              </span>
            </span>
          </label>

          <label class="toggle-item">
            <span class="label">سبورة تقليدية</span>
            <span style="margin-inline-start:auto;">
              <span class="switch">
                <input type="checkbox" id="board" />
                <span class="knob" aria-hidden="true"></span>
                <span class="switch-bg-active" style="position:absolute; inset:0; border-radius:999px; pointer-events:none;"></span>
              </span>
            </span>
          </label>

          <label class="toggle-item">
            <span class="label">سبورة ذكية</span>
            <span style="margin-inline-start:auto;">
              <span class="switch">
                <input type="checkbox" id="smartboard" />
                <span class="knob" aria-hidden="true"></span>
                <span class="switch-bg-active" style="position:absolute; inset:0; border-radius:999px; pointer-events:none;"></span>
              </span>
            </span>
          </label>

          <label class="toggle-item">
            <span class="label">بطاقات تعليمية</span>
            <span style="margin-inline-start:auto;">
              <span class="switch">
                <input type="checkbox" id="cards" />
                <span class="knob" aria-hidden="true"></span>
                <span class="switch-bg-active" style="position:absolute; inset:0; border-radius:999px; pointer-events:none;"></span>
              </span>
            </span>
          </label>

          <label class="toggle-item">
            <span class="label">عرض تقديمي</span>
            <span style="margin-inline-start:auto;">
              <span class="switch">
                <input type="checkbox" id="presentation" />
                <span class="knob" aria-hidden="true"></span>
                <span class="switch-bg-active" style="position:absolute; inset:0; border-radius:999px; pointer-events:none;"></span>
              </span>
            </span>
          </label>

          <label class="toggle-item">
            <span class="label">أوراق عمل</span>
            <span style="margin-inline-start:auto;">
              <span class="switch">
                <input type="checkbox" id="worksheets" />
                <span class="knob" aria-hidden="true"></span>
                <span class="switch-bg-active" style="position:absolute; inset:0; border-radius:999px; pointer-events:none;"></span>
              </span>
            </span>
          </label>
        </div>
      </div>

      <!-- Witness images -->
      <div class="section">
        <label>صورة الشاهد الأول</label>
        <input type="file" id="witness1" accept="image/*">
        <div id="witness1Error" class="error-message">هذا الحقل مطلوب (يجب رفع شاهد واحد على الأقل)</div>

        <label style="margin-top:12px">صورة الشاهد الثاني</label>
        <input type="file" id="witness2" accept="image/*">
      </div>

      <!-- Barcode link -->
      <div class="section">
        <label>ضع رابط الشواهد إن وجد لإنشاء باركود ووضعه بالنموذج</label>
        <input type="text" id="evidenceLink">
      </div>

      <!-- Actions -->
      <div class="actions">
        <button type="button" class="btn green" id="previewBtn">معاينة</button>
        <button type="reset" class="btn ghost">إعادة تعيين</button>
        <span class="small">سيتم إنشاء باركود ورفع الملف عند المعالجة</span>
      </div>

    </form>


  </div>
</div>

<!-- Modal Popup للمعاينة -->
<div id="previewModal" class="modal-overlay">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="text-2xl font-bold text-gray-800">معاينة نموذج تنفيذ الاستراتيجية</h2>
      <button class="modal-close" id="closeModal">&times;</button>
    </div>
    <div class="modal-body">
      <div id="previewTemplateContent" class="preview-template">
        <!-- سيتم ملء المحتوى ديناميكياً -->
      </div>
      <div class="download-buttons">
        <button onclick="downloadImageFromModal()" class="btn-download btn-download-image">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
            <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
            <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/>
          </svg>
          تحميل كصورة
        </button>
        <button onclick="downloadPDFFromModal()" class="btn-download btn-download-pdf">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
            <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
            <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/>
          </svg>
          تحميل PDF
        </button>
        <button onclick="closePreviewModal()" class="btn-download btn-close">
          إغلاق
        </button>
      </div>
    </div>
  </div>
</div>

<!-- FOOTER -->
    <footer class="mt-12 footer-ink border-t border-gray-100">
      <div
        class="max-w-6xl mx-auto px-6 py-8 flex flex-col md:flex-row md:items-center md:justify-between gap-6"
      >
        <!-- RIGHT COLUMN -->
        <div class="text-right md:flex-1">
          <img
            src="../assets/imgs/gsoor_logo.jpg"
            alt="logo"
            class="h-10 mx-auto md:mx-0"
          />
          <div
            class="flex justify-center md:justify-end gap-4 mt-3 text-gray-600"
          >
            <i class="fa-brands fa-youtube social-icon text-lg"></i>
            <i class="fa-brands fa-tiktok social-icon text-lg"></i>
            <i class="fa-brands fa-instagram social-icon text-lg"></i>
          </div>
        </div>

        <!-- CENTER COLUMN -->
        <div class="text-center md:flex-1">
          <h3 class="font-bold mb-2">تواصل معنا</h3>
          <div class="flex items-center justify-center gap-4 text-gray-600">
            <div class="flex items-center gap-2">
              <i class="fa-regular fa-envelope text-sm"></i>
              <span>البريد</span>
            </div>
            <div class="flex items-center gap-2">
              <i class="fa-solid fa-mobile-screen-button text-sm"></i>
              <span>واتس</span>
            </div>
          </div>
          <div class="mt-3 text-sm text-gray-500">موقّع لدى منصة الأعمال</div>
        </div>

        <!-- LEFT COLUMN -->
        <div class="text-left md:flex-1">
          <div class="text-sm text-gray-500">
            © 2025 متجر جسور الرقمي | جميع الحقوق محفوظة
          </div>
          <div
            class="mt-3 flex gap-2 items-center justify-center md:justify-start"
          >
            <span class="sr-only">Visa</span>
            <i class="fa-brands fa-cc-visa text-gray-600 text-lg"></i>
            <span class="sr-only">Mada</span>
            <i class="fa-solid fa-credit-card text-gray-600 text-lg"></i>
          </div>
        </div>
      </div>
    </footer>
  <script>
    // تهيئة التحقق من الحقول
    function setupFieldValidation() {
      const textFields = [
        'educationDept', 'schoolName', 'executionDate', 'subject', 
        'learningStrategy', 'beneficiariesCount', 'educationStage', 
        'class', 'lessonName', 'objectives', 'teacherName', 'otherName'
      ];

      // معالجة حقول النص
      textFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
          field.addEventListener('input', function() {
            this.classList.remove('field-error');
            const errorId = fieldId + 'Error';
            const error = document.getElementById(errorId);
            if (error) {
              error.classList.remove('show');
            }
          });
        }
      });

      // معالجة حقول الملفات
      const fileFields = ['witness1', 'witness2'];
      fileFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
          field.addEventListener('change', function() {
            this.classList.remove('field-error');
            const errorId = fieldId + 'Error';
            const error = document.getElementById(errorId);
            if (error) {
              error.classList.remove('show');
            }
          });
        }
      });
    }

    // دالة التحقق من صحة البيانات
    function validateForm() {
      let isValid = true;
      
      // إزالة رسائل الخطأ السابقة
      document.querySelectorAll('.error-message').forEach(error => {
        error.classList.remove('show');
      });
      document.querySelectorAll('.field-error').forEach(field => {
        field.classList.remove('field-error');
      });

      // التحقق من الحقول النصية المطلوبة
      const requiredFields = [
        'educationDept', 'schoolName', 'executionDate', 'subject', 
        'learningStrategy', 'beneficiariesCount', 'educationStage', 
        'class', 'lessonName', 'objectives', 'teacherName', 'otherName'
      ];

      requiredFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field && !field.value.trim()) {
          showError(fieldId, fieldId + 'Error');
          isValid = false;
        }
      });

      // التحقق من صورة الشاهد الأول (مطلوب على الأقل شاهد واحد)
      const witness1 = document.getElementById('witness1').files[0];
      if (!witness1) {
        showError('witness1', 'witness1Error');
        isValid = false;
      }

      return isValid;
    }

    // دالة لإظهار رسالة الخطأ
    function showError(fieldId, errorId) {
      const field = document.getElementById(fieldId);
      const error = document.getElementById(errorId);
      if (field) {
        field.classList.add('field-error');
      }
      if (error) {
        error.classList.add('show');
      }
    }

    // دالة حفظ البيانات
    function saveFormData() {
      const formData = {
        educationDept: document.getElementById('educationDept').value,
        schoolName: document.getElementById('schoolName').value,
        executionDate: document.getElementById('executionDate').value,
        subject: document.getElementById('subject').value,
        learningStrategy: document.getElementById('learningStrategy').value,
        beneficiariesCount: document.getElementById('beneficiariesCount').value,
        educationStage: document.getElementById('educationStage').value,
        class: document.getElementById('class').value,
        lessonName: document.getElementById('lessonName').value,
        objectives: document.getElementById('objectives').value,
        teacherName: document.getElementById('teacherName').value,
        otherName: document.getElementById('otherName').value,
        twitterAccount: document.getElementById('twitterAccount').value,
        evidenceLink: document.getElementById('evidenceLink').value,
        // حفظ حالة الوسائل التعليمية
        educationalTools: {
          projector: document.getElementById('proj').checked,
          computer: document.getElementById('pc').checked,
          image: document.getElementById('img').checked,
          sports: document.getElementById('sports').checked,
          book: document.getElementById('book').checked,
          board: document.getElementById('board').checked,
          smartboard: document.getElementById('smartboard').checked,
          cards: document.getElementById('cards').checked,
          presentation: document.getElementById('presentation').checked,
          worksheets: document.getElementById('worksheets').checked
        }
      };

      localStorage.setItem('strategyImplementationData', JSON.stringify(formData));
      return formData;
    }

    // دالة توليد محتوى المعاينة
    function generatePreviewContent() {
      const data = JSON.parse(localStorage.getItem('strategyImplementationData') || '{}');
      const previewContainer = document.getElementById('previewTemplateContent');

      // توليد قائمة الوسائل التعليمية المختارة
      const selectedTools = [];
      if (data.educationalTools) {
        const toolsMap = {
          projector: 'جهاز عرض',
          computer: 'جهاز حاسب',
          image: 'صورة توضيحية',
          sports: 'أدوات رياضية',
          book: 'كتاب',
          board: 'سبورة تقليدية',
          smartboard: 'سبورة ذكية',
          cards: 'بطاقات تعليمية',
          presentation: 'عرض تقديمي',
          worksheets: 'أوراق عمل'
        };

        Object.keys(data.educationalTools).forEach(tool => {
          if (data.educationalTools[tool]) {
            selectedTools.push(toolsMap[tool]);
          }
        });
      }

      let html = `
        <div class="space-y-6 text-right" id="previewContent">
          <div class="text-center mb-6">
            <h2 class="text-2xl font-bold text-green-800 mb-4">نموذج تنفيذ استراتيجية مختصرة</h2>
          </div>

          <div class="grid grid-cols-2 gap-4">
            <div><strong>إدارة التعليم / المنطقة:</strong> ${data.educationDept || ''}</div>
            <div><strong>اسم المدرسة:</strong> ${data.schoolName || ''}</div>
            <div><strong>تاريخ التنفيذ:</strong> ${data.executionDate || ''}</div>
            <div><strong>المادة:</strong> ${data.subject || ''}</div>
            <div><strong>استراتيجية التعلم:</strong> ${data.learningStrategy || ''}</div>
            <div><strong>عدد المستفيدين:</strong> ${data.beneficiariesCount || ''}</div>
            <div><strong>المرحلة الدراسية:</strong> ${data.educationStage || ''}</div>
            <div><strong>الفصل:</strong> ${data.class || ''}</div>
            <div><strong>اسم الدرس:</strong> ${data.lessonName || ''}</div>
          </div>

          <div>
            <strong>الأهداف:</strong>
            <p class="mt-2 p-3 bg-gray-50 rounded whitespace-pre-line">${data.objectives || ''}</p>
          </div>

          <div>
            <strong>اسم المعلم:</strong>
            <p class="mt-2 p-3 bg-gray-50 rounded whitespace-pre-line">${data.teacherName || ''}</p>
          </div>

          <div class="grid grid-cols-2 gap-4">
            <div>
              <strong>اسم آخر:</strong>
              <p>${data.otherName || ''}</p>
            </div>
            <div>
              <strong>حساب تويتر:</strong>
              <p>${data.twitterAccount || ''}</p>
            </div>
          </div>

          ${selectedTools.length > 0 ? `
            <div>
              <strong>الوسائل التعليمية المستخدمة:</strong>
              <p class="mt-2 p-3 bg-gray-50 rounded">${selectedTools.join('، ')}</p>
            </div>
          ` : ''}

          ${data.evidenceLink ? `
            <div class="mt-6">
              <strong>رابط الشواهد:</strong>
              <p class="text-blue-600 break-all">${data.evidenceLink}</p>
            </div>
          ` : ''}
        </div>
      `;

      previewContainer.innerHTML = html;
    }

    // فتح الـ modal
    function openPreviewModal() {
      const modal = document.getElementById('previewModal');
      modal.classList.add('active');
      document.body.style.overflow = 'hidden';
    }

    // إغلاق الـ modal
    function closePreviewModal() {
      const modal = document.getElementById('previewModal');
      modal.classList.remove('active');
      document.body.style.overflow = 'auto';
    }

    // تحميل الصورة من الـ modal
    function downloadImageFromModal() {
      const previewContent = document.getElementById('previewTemplateContent');
      
      // إظهار رسالة تحميل
      const downloadBtn = event.target;
      const originalText = downloadBtn.innerHTML;
      downloadBtn.innerHTML = 'جاري التحميل...';
      downloadBtn.disabled = true;

      html2canvas(previewContent, {
        backgroundColor: '#ffffff',
        scale: 2,
        useCORS: true,
        logging: false
      }).then((canvas) => {
        const link = document.createElement('a');
        link.download = `نموذج-تنفيذ-استراتيجية-${new Date().toLocaleDateString('ar-SA')}.png`;
        link.href = canvas.toDataURL('image/png', 1.0);
        link.click();
        
        // إعادة زر التحميل إلى حالته الأصلية
        downloadBtn.innerHTML = originalText;
        downloadBtn.disabled = false;
      }).catch(error => {
        console.error('Error generating image:', error);
        alert('حدث خطأ أثناء تحميل الصورة');
        downloadBtn.innerHTML = originalText;
        downloadBtn.disabled = false;
      });
    }

    // تحميل PDF من الـ modal
    function downloadPDFFromModal() {
      const previewContent = document.getElementById('previewTemplateContent');
      
      // إظهار رسالة تحميل
      const downloadBtn = event.target;
      const originalText = downloadBtn.innerHTML;
      downloadBtn.innerHTML = 'جاري التحميل...';
      downloadBtn.disabled = true;

      html2canvas(previewContent, {
        backgroundColor: '#ffffff',
        scale: 2,
        useCORS: true,
        logging: false
      }).then((canvas) => {
        const imgData = canvas.toDataURL('image/jpeg', 0.9);
        const pdf = new jspdf.jsPDF('p', 'mm', 'a4');
        const imgWidth = 190;
        const pageHeight = 280;
        const imgHeight = (canvas.height * imgWidth) / canvas.width;
        
        let heightLeft = imgHeight;
        let position = 10;

        // الصفحة الأولى
        pdf.addImage(imgData, 'JPEG', 10, position, imgWidth, imgHeight);
        heightLeft -= pageHeight;

        // إضافة صفحات إضافية إذا كان المحتوى طويلاً
        while (heightLeft >= 0) {
          position = heightLeft - imgHeight + 10;
          pdf.addPage();
          pdf.addImage(imgData, 'JPEG', 10, position, imgWidth, imgHeight);
          heightLeft -= pageHeight;
        }

        pdf.save(`نموذج-تنفيذ-استراتيجية-${new Date().toLocaleDateString('ar-SA')}.pdf`);
        
        // إعادة زر التحميل إلى حالته الأصلية
        downloadBtn.innerHTML = originalText;
        downloadBtn.disabled = false;
      }).catch(error => {
        console.error('Error generating PDF:', error);
        alert('حدث خطأ أثناء تحميل PDF');
        downloadBtn.innerHTML = originalText;
        downloadBtn.disabled = false;
      });
    }

    // دالة المعاينة الرئيسية
    function previewTemplate() {
      // التحقق من صحة البيانات أولاً
      if (!validateForm()) {
        // التمرير إلى أول حقل به خطأ
        const firstError = document.querySelector('.field-error');
        if (firstError) {
          firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
        return;
      }

      // إذا كانت البيانات صحيحة، حفظها وفتح المعاينة
      saveFormData();
      generatePreviewContent();
      openPreviewModal();
    }

    // تهيئة الأحداث عند تحميل الصفحة
    document.addEventListener('DOMContentLoaded', function() {
      // تهيئة التحقق من الحقول
      setupFieldValidation();

      // ربط زر المعاينة
      document.getElementById('previewBtn').addEventListener('click', previewTemplate);

      // ربط زر إغلاق الـ modal
      document.getElementById('closeModal').addEventListener('click', closePreviewModal);

      // إغلاق الـ modal عند الضغط خارج المحتوى
      document.getElementById('previewModal').addEventListener('click', function(e) {
        if (e.target === this) {
          closePreviewModal();
        }
      });

      // إغلاق الـ modal عند الضغط على ESC
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
          closePreviewModal();
        }
      });

      // تحميل البيانات المحفوظة إن وجدت
      const savedData = JSON.parse(localStorage.getItem('strategyImplementationData') || '{}');
      Object.keys(savedData).forEach(key => {
        if (key !== 'educationalTools') {
          const field = document.getElementById(key);
          if (field) {
            field.value = savedData[key];
          }
        }
      });

      // تحميل حالة الوسائل التعليمية
      if (savedData.educationalTools) {
        Object.keys(savedData.educationalTools).forEach(toolId => {
          const checkbox = document.getElementById(toolId);
          if (checkbox) {
            checkbox.checked = savedData.educationalTools[toolId];
            // تشغيل حدث التحديث للتبديل
            const event = new Event('change');
            checkbox.dispatchEvent(event);
          }
        });
      }

      // تهيئة تبديلات الوسائل التعليمية
      document.querySelectorAll('.switch input').forEach(chk=>{
        const update = () => {
          const wrapper = chk.closest('.switch');
          const active = wrapper.querySelector('.switch-bg-active');
          if(chk.checked){
            active.style.background = getComputedStyle(document.documentElement).getPropertyValue('--switch-on') || '#4f46e5';
          } else {
            active.style.background = getComputedStyle(document.documentElement).getPropertyValue('--switch-bg') || '#e6e7ee';
          }
        };
        chk.addEventListener('change', update);
        update();
      });
    });
  </script>
</body>
</html>
