<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>تقرير تنفيذ برنامج (تغطية) شاهدين</title>
  
  <!-- Add required libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
  <!-- Add this to your head section -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer">

  <style>
    :root{
      --bg:#f6f8fa;
      --card:#fff;
      --accent:#2aa44f;
      --muted:#6b7280;
      --input:#f3f4f6;
      --error:#dc2626;
    }
    *{box-sizing:border-box;font-family:Tahoma,Arial, sans-serif}
    body{background:var(--bg);padding:24px;color:#111; margin: 0; padding-top:100px;}
    .container{max-width:920px;margin:0 auto}
    .card{background:var(--card);border-radius:12px;padding:22px 24px;box-shadow:0 6px 20px rgba(2,6,23,0.06)}
    h1{font-size:20px;margin:0 0 6px; text-align: center;}
    p.lead{color:var(--muted);margin:0 0 20px; text-align: center; line-height: 1.6;}
    .top-img{display:flex;justify-content:center;margin-bottom:14px}
    .top-img img{width:120px;height:120px;border-radius:50%;object-fit:cover;border:6px solid #fff;box-shadow:0 4px 12px rgba(0,0,0,0.08)}

    form .row{display:flex;gap:12px;margin-bottom:12px}
    form .col{flex:1}
    label{display:block;font-size:13px;margin-bottom:6px;color:#0f172a; font-weight: 600;}
    input[type=text], textarea, select, input[type=date], input[type=file]{
      width:100%;
      padding:10px;
      border-radius:8px;
      border:1px solid #e6e9ee;
      background:var(--input);
      font-size:14px;
      margin-bottom: 8px;
    }
    textarea{min-height:90px;resize:vertical}

    .small{font-size:12px;color:var(--muted)}
    .actions{
      display:flex;
      gap:10px;
      align-items:center;
      margin-top:14px;
      flex-wrap: wrap;
    }
    
.footer-ink {
        background: #f8fafb;
      }

      .social-icon {
        width: 26px;
        height: 26px;
        fill: currentColor;
      }


    .btn{
      padding:10px 18px;
      border-radius:8px;
      border:0;
      cursor:pointer;
      font-weight:600;
      transition: all 0.3s;
    }
    .btn.green{
      background:var(--accent);
      color:#fff;
    }
    .btn.green:hover{
      background:#238c43;
    }
    .btn.ghost{
      background:transparent;
      border:1px solid #d1d5db;
      color:#111;
    }
    .btn.ghost:hover{
      background:#f9fafb;
    }

    .section{
      margin-top:18px;
      padding-top:12px;
      border-top:1px dashed #e6e9ee
    }
    .two-cols{display:flex;gap:12px}
    .two-cols > *{flex:1}

    /* Error Styles */
    .error-message {
      color: var(--error);
      font-size: 11px;
      margin-top: 4px;
      display: none;
    }
    .error-message.show {
      display: block;
    }
    .field-error {
      border-color: var(--error) !important;
      border-width: 2px !important;
    }

    /* Modal Styles */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.7);
      z-index: 1000;
      overflow-y: auto;
      padding: 20px;
    }
    .modal-overlay.active {
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .modal-content {
      background: white;
      border-radius: 16px;
      max-width: 90%;
      width: 100%;
      max-width: 800px;
      position: relative;
      margin: auto;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px;
      border-bottom: 1px solid #e5e7eb;
    }
    .modal-body {
      padding: 20px;
      max-height: calc(100vh - 200px);
      overflow-y: auto;
    }
    .modal-close {
      background: none;
      border: none;
      font-size: 28px;
      cursor: pointer;
      color: #6b7280;
      padding: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: all 0.2s;
    }
    .modal-close:hover {
      background-color: #f3f4f6;
      color: #111827;
    }
    .preview-template {
      background: white;
      padding: 30px;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
    }

    /* Download Buttons */
    .download-buttons {
      display: flex;
      justify-content: center;
      gap: 12px;
      margin-top: 20px;
      flex-wrap: wrap;
    }
    .btn-download {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.3s;
    }
    .btn-download-pdf {
      background: #dc2626;
      color: white;
    }
    .btn-download-pdf:hover {
      background: #b91c1c;
    }
    .btn-download-image {
      background: #2563eb;
      color: white;
    }
    .btn-download-image:hover {
      background: #1d4ed8;
    }
    .btn-close {
      background: #6b7280;
      color: white;
    }
    .btn-close:hover {
      background: #4b5563;
    }

    @media (max-width:720px){
      form .row, .two-cols{flex-direction:column}
      .top-img img{width:88px;height:88px}
      .download-buttons {
        flex-direction: column;
        align-items: center;
      }
      .btn-download {
        width: 200px;
        justify-content: center;
      }
      .actions {
        flex-direction: column;
        align-items: flex-start;
      }
    }
  </style>
</head>
<body>
  <!-- NAVBAR WITHOUT CART -->
<header class="fixed inset-x-0 top-4 z-50 px-4 sm:px-6">
  <div class="max-w-6xl mx-auto relative">
    <div class="nav-pill px-3 py-2 flex items-center justify-between gap-3">
      <!-- LOGO -->
      <div class="flex items-center gap-4 ml-2">
        <a href="#" class="shrink-0">
          <img
            src="../assets/imgs/gsoor_logo.jpg"
            alt="logo"
            class="h-9 w-auto object-contain md:h-10"
          />
        </a>
      </div>

      <!-- NAV LINKS (desktop) -->
      <nav class="hidden md:flex items-center gap-8 text-sm text-gray-700">
        <a href="#" class="hover:text-cyan-600 transition">الشهادات</a>
        <a href="#" class="hover:text-cyan-600 transition">الملفات الإدارية</a>
        <a href="#" class="hover:text-cyan-600 transition">البطاقات</a>
      </nav>

      <!-- UTILITY ICONS WITHOUT CART -->
      <div class="flex items-center gap-2">
        <div class="hidden sm:flex items-center bg-gray-50 rounded-full px-2 py-1 gap-2 border border-gray-100">
          <button id="themeToggle" class="text-gray-600" title="تبديل الوضع">
            <i class="fa-solid fa-moon text-gray-600 text-base"></i>
          </button>
          <button id="profileBtn" class="text-gray-600" title="الحساب">
            <i class="fa-regular fa-user text-gray-600 text-base"></i>
          </button>
        </div>

        <!-- MOBILE MENU BUTTON -->
        <button id="menuBtn" class="md:hidden text-gray-600 p-2" aria-expanded="false">
          <i class="fa-solid fa-bars text-lg"></i>
        </button>
      </div>
    </div>

    <!-- MOBILE NAV WITHOUT CART -->
    <div id="mobileNav" class="hidden mobile-nav-abs mt-2 bg-white rounded-2xl shadow-md p-3 mx-4">
      <div class="flex flex-col gap-2 text-right">
        <a href="#" class="py-2 px-3 rounded hover:bg-gray-50 transition">الشهادات</a>
        <a href="#" class="py-2 px-3 rounded hover:bg-gray-50 transition">الملفات الإدارية</a>
        <a href="#" class="py-2 px-3 rounded hover:bg-gray-50 transition">البطاقات</a>
        <div class="pt-2 border-t border-gray-100 mt-2 flex justify-between items-center">
          <div class="flex items-center gap-3">
            <button id="mobileThemeToggle" class="text-gray-600">
              <i class="fa-solid fa-moon"></i>
            </button>
          </div>
          <a href="#" class="text-sm text-cyan-600 font-semibold">تسجيل دخول</a>
        </div>
      </div>
    </div>
  </div>
</header>
<script>
  // NAVBAR FUNCTIONALITY WITHOUT CART
  document.addEventListener('DOMContentLoaded', function() {
    const menuBtn = document.getElementById("menuBtn");
    const mobileNav = document.getElementById("mobileNav");
    const mobileThemeToggle = document.getElementById("mobileThemeToggle");

    // Mobile menu toggle
    if (menuBtn) {
      menuBtn.addEventListener("click", (e) => {
        const expanded = menuBtn.getAttribute("aria-expanded") === "true";
        menuBtn.setAttribute("aria-expanded", String(!expanded));
        mobileNav.classList.toggle("hidden");
      });
    }

    // Close mobile menu when clicking outside
    document.addEventListener("click", (e) => {
      if (!mobileNav || mobileNav.classList.contains("hidden")) return;
      const path = e.composedPath?.() || e.path || [];
      if (!path.includes(mobileNav) && !path.includes(menuBtn)) {
        mobileNav.classList.add("hidden");
        if (menuBtn) menuBtn.setAttribute("aria-expanded", "false");
      }
    });

    // Close mobile menu on window resize
    window.addEventListener("resize", () => {
      if (window.innerWidth >= 768) {
        mobileNav.classList.add("hidden");
        if (menuBtn) menuBtn.setAttribute("aria-expanded", "false");
      }
    });

    // Theme toggle
    document.getElementById("themeToggle")?.addEventListener("click", () => {
      document.documentElement.classList.toggle("dark");
    });
    
    if (mobileThemeToggle) {
      mobileThemeToggle.addEventListener("click", () => {
        document.documentElement.classList.toggle("dark");
      });
    }
  });
</script>
  <div class="container">
    <div class="card">
      <div class="top-img">
        <img src="/mnt/data/76271298-6d31-418f-bd84-eba3e391710a.png" alt="logo">
      </div>
      <h1>تقرير تنفيذ برنامج (تغطية) شاهدين</h1>
      <p class="lead">إنشاء وتخصيص تقرير تنفيذ برنامج (تغطية) شاهدين مع إمكانية تحرير وإضافة جميع البيانات الخاصة بك، بطريقة سهلة واحترافية توفر عليه الوقت والجهد ويتم حفظ الملف النهائي بتنسيق صورة أو ملف pdf لسهولة الطباعة بجودة عالية وإعادة الاستخدام في تقارير ونماذج أخرى.</p>

      <form id="docForm">
        <div class="row">
          <div class="col">
            <label>إدارة التعليم, المنطقة, مكتب التعليم</label>
            <input type="text" id="educationInfo" placeholder="">
            <div id="educationInfoError" class="error-message">هذا الحقل مطلوب</div>
          </div>
        </div>

        <div class="row">
          <div class="col">
            <label>اسم المدرسة</label>
            <input type="text" id="schoolName" placeholder="">
            <div id="schoolNameError" class="error-message">هذا الحقل مطلوب</div>
          </div>
        </div>

        <div class="row">
          <div class="col">
            <label>اسم البرنامج</label>
            <input type="text" id="programName" placeholder="">
            <div id="programNameError" class="error-message">هذا الحقل مطلوب</div>
          </div>
        </div>

        <div class="row">
          <div class="col">
            <label>اسم منفذ البرنامج أو المنفذين</label>
            <input type="text" id="implementers" placeholder="">
            <div id="implementersError" class="error-message">هذا الحقل مطلوب</div>
          </div>
        </div>

        <div class="row">
          <div class="col">
            <label>مكان التنفيذ</label>
            <input type="text" id="location" placeholder="">
            <div id="locationError" class="error-message">هذا الحقل مطلوب</div>
          </div>
        </div>

        <div class="row">
          <div class="col">
            <label>المستهدفون</label>
            <input type="text" id="targetAudience" placeholder="">
            <div id="targetAudienceError" class="error-message">هذا الحقل مطلوب</div>
          </div>
        </div>

        <div class="row">
          <div class="col">
            <label>عدد المستهدفين</label>
            <input type="text" id="targetCount" placeholder="">
            <div id="targetCountError" class="error-message">هذا الحقل مطلوب</div>
          </div>
        </div>

        <div class="row">
          <div class="col">
            <label>تاريخ التنفيذ</label>
            <input type="text" id="executionDate" placeholder="">
            <div id="executionDateError" class="error-message">هذا الحقل مطلوب</div>
          </div>
        </div>

        <div class="row">
          <div class="col">
            <label>حساب تويتر (إختياري)</label>
            <input type="text" id="twitterAccount" placeholder="">
          </div>
        </div>

        <div class="section">
          <label>الأهداف</label>
          <textarea id="objectives" placeholder=""></textarea>
          <div id="objectivesError" class="error-message">هذا الحقل مطلوب</div>
        </div>

        <div class="section">
          <label>صورة الشاهد الأول</label>
          <input type="file" id="witness1" accept="image/*">
          <div id="witness1Error" class="error-message">هذا الحقل مطلوب (يجب رفع شاهد واحد على الأقل)</div>

          <label style="margin-top: 12px; display: block;">صورة الشاهد الثاني</label>
          <input type="file" id="witness2" accept="image/*">
        </div>

        <div class="actions">
          <button type="button" class="btn green" id="previewBtn">معاينة</button>
          <button type="reset" class="btn ghost">إعادة تعيين</button>
          <span class="small">سيتم إنشاء باركود ورفع الملف عند المعالجة</span>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Popup للمعاينة -->
  <div id="previewModal" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="text-2xl font-bold text-gray-800">معاينة تقرير تنفيذ البرنامج</h2>
        <button class="modal-close" id="closeModal">&times;</button>
      </div>
      <div class="modal-body">
        <div id="previewTemplateContent" class="preview-template">
          <!-- سيتم ملء المحتوى ديناميكياً -->
        </div>
        <div class="download-buttons">
          <button onclick="downloadImageFromModal()" class="btn-download btn-download-image">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
              <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
              <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/>
            </svg>
            تحميل كصورة
          </button>
          <button onclick="downloadPDFFromModal()" class="btn-download btn-download-pdf">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
              <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
              <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/>
            </svg>
            تحميل PDF
          </button>
          <button onclick="closePreviewModal()" class="btn-download btn-close">
            إغلاق
          </button>
        </div>
      </div>
    </div>
  </div>

<!-- FOOTER -->
    <footer class="mt-12 footer-ink border-t border-gray-100">
      <div
        class="max-w-6xl mx-auto px-6 py-8 flex flex-col md:flex-row md:items-center md:justify-between gap-6"
      >
        <!-- RIGHT COLUMN -->
        <div class="text-right md:flex-1">
          <img
            src="../assets/imgs/gsoor_logo.jpg"
            alt="logo"
            class="h-10 mx-auto md:mx-0"
          />
          <div
            class="flex justify-center md:justify-end gap-4 mt-3 text-gray-600"
          >
            <i class="fa-brands fa-youtube social-icon text-lg"></i>
            <i class="fa-brands fa-tiktok social-icon text-lg"></i>
            <i class="fa-brands fa-instagram social-icon text-lg"></i>
          </div>
        </div>

        <!-- CENTER COLUMN -->
        <div class="text-center md:flex-1">
          <h3 class="font-bold mb-2">تواصل معنا</h3>
          <div class="flex items-center justify-center gap-4 text-gray-600">
            <div class="flex items-center gap-2">
              <i class="fa-regular fa-envelope text-sm"></i>
              <span>البريد</span>
            </div>
            <div class="flex items-center gap-2">
              <i class="fa-solid fa-mobile-screen-button text-sm"></i>
              <span>واتس</span>
            </div>
          </div>
          <div class="mt-3 text-sm text-gray-500">موقّع لدى منصة الأعمال</div>
        </div>

        <!-- LEFT COLUMN -->
        <div class="text-left md:flex-1">
          <div class="text-sm text-gray-500">
            © 2025 متجر جسور الرقمي | جميع الحقوق محفوظة
          </div>
          <div
            class="mt-3 flex gap-2 items-center justify-center md:justify-start"
          >
            <span class="sr-only">Visa</span>
            <i class="fa-brands fa-cc-visa text-gray-600 text-lg"></i>
            <span class="sr-only">Mada</span>
            <i class="fa-solid fa-credit-card text-gray-600 text-lg"></i>
          </div>
        </div>
      </div>
    </footer>
  <script>
    // تهيئة التحقق من الحقول
    function setupFieldValidation() {
      const textFields = [
        'educationInfo', 'schoolName', 'programName', 'implementers',
        'location', 'targetAudience', 'targetCount', 'executionDate',
        'objectives'
      ];

      // معالجة حقول النص
      textFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
          field.addEventListener('input', function() {
            this.classList.remove('field-error');
            const errorId = fieldId + 'Error';
            const error = document.getElementById(errorId);
            if (error) {
              error.classList.remove('show');
            }
          });
        }
      });

      // معالجة حقول الملفات
      const fileFields = ['witness1', 'witness2'];
      fileFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
          field.addEventListener('change', function() {
            this.classList.remove('field-error');
            const errorId = fieldId + 'Error';
            const error = document.getElementById(errorId);
            if (error) {
              error.classList.remove('show');
            }
          });
        }
      });
    }

    // دالة التحقق من صحة البيانات
    function validateForm() {
      let isValid = true;
      
      // إزالة رسائل الخطأ السابقة
      document.querySelectorAll('.error-message').forEach(error => {
        error.classList.remove('show');
      });
      document.querySelectorAll('.field-error').forEach(field => {
        field.classList.remove('field-error');
      });

      // التحقق من الحقول النصية المطلوبة
      const requiredFields = [
        'educationInfo', 'schoolName', 'programName', 'implementers',
        'location', 'targetAudience', 'targetCount', 'executionDate',
        'objectives'
      ];

      requiredFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field && !field.value.trim()) {
          showError(fieldId, fieldId + 'Error');
          isValid = false;
        }
      });

      // التحقق من صورة الشاهد الأول (مطلوب على الأقل شاهد واحد)
      const witness1 = document.getElementById('witness1').files[0];
      if (!witness1) {
        showError('witness1', 'witness1Error');
        isValid = false;
      }

      return isValid;
    }

    // دالة لإظهار رسالة الخطأ
    function showError(fieldId, errorId) {
      const field = document.getElementById(fieldId);
      const error = document.getElementById(errorId);
      if (field) {
        field.classList.add('field-error');
      }
      if (error) {
        error.classList.add('show');
      }
    }

    // دالة حفظ البيانات
    function saveFormData() {
      const formData = {
        educationInfo: document.getElementById('educationInfo').value,
        schoolName: document.getElementById('schoolName').value,
        programName: document.getElementById('programName').value,
        implementers: document.getElementById('implementers').value,
        location: document.getElementById('location').value,
        targetAudience: document.getElementById('targetAudience').value,
        targetCount: document.getElementById('targetCount').value,
        executionDate: document.getElementById('executionDate').value,
        twitterAccount: document.getElementById('twitterAccount').value,
        objectives: document.getElementById('objectives').value
      };

      localStorage.setItem('programReportData', JSON.stringify(formData));
      return formData;
    }

    // دالة توليد محتوى المعاينة
    function generatePreviewContent() {
      const data = JSON.parse(localStorage.getItem('programReportData') || '{}');
      const previewContainer = document.getElementById('previewTemplateContent');

      let html = `
        <div class="space-y-6 text-right" id="previewContent">
          <div class="text-center mb-6">
            <h2 class="text-2xl font-bold text-green-800 mb-4">تقرير تنفيذ برنامج (تغطية) شاهدين</h2>
          </div>

          <div class="grid grid-cols-2 gap-4">
            <div><strong>إدارة التعليم, المنطقة, مكتب التعليم:</strong> ${data.educationInfo || ''}</div>
            <div><strong>اسم المدرسة:</strong> ${data.schoolName || ''}</div>
            <div><strong>اسم البرنامج:</strong> ${data.programName || ''}</div>
            <div><strong>اسم المنفذين:</strong> ${data.implementers || ''}</div>
            <div><strong>مكان التنفيذ:</strong> ${data.location || ''}</div>
            <div><strong>المستهدفون:</strong> ${data.targetAudience || ''}</div>
            <div><strong>عدد المستهدفين:</strong> ${data.targetCount || ''}</div>
            <div><strong>تاريخ التنفيذ:</strong> ${data.executionDate || ''}</div>
            ${data.twitterAccount ? `<div><strong>حساب تويتر:</strong> ${data.twitterAccount}</div>` : ''}
          </div>

          <div>
            <strong>الأهداف:</strong>
            <p class="mt-2 p-3 bg-gray-50 rounded whitespace-pre-line">${data.objectives || ''}</p>
          </div>

          <div class="mt-6 p-4 bg-yellow-50 border border-yellow-200 rounded">
            <strong>ملاحظة:</strong> تم رفع صور الشواهد وسيتم عرضها في النسخة النهائية
          </div>
        </div>
      `;

      previewContainer.innerHTML = html;
    }

    // فتح الـ modal
    function openPreviewModal() {
      const modal = document.getElementById('previewModal');
      modal.classList.add('active');
      document.body.style.overflow = 'hidden';
    }

    // إغلاق الـ modal
    function closePreviewModal() {
      const modal = document.getElementById('previewModal');
      modal.classList.remove('active');
      document.body.style.overflow = 'auto';
    }

    // تحميل الصورة من الـ modal
    function downloadImageFromModal() {
      const previewContent = document.getElementById('previewTemplateContent');
      
      // إظهار رسالة تحميل
      const downloadBtn = event.target;
      const originalText = downloadBtn.innerHTML;
      downloadBtn.innerHTML = 'جاري التحميل...';
      downloadBtn.disabled = true;

      html2canvas(previewContent, {
        backgroundColor: '#ffffff',
        scale: 2,
        useCORS: true,
        logging: false
      }).then((canvas) => {
        const link = document.createElement('a');
        link.download = `تقرير-تنفيذ-برنامج-${new Date().toLocaleDateString('ar-SA')}.png`;
        link.href = canvas.toDataURL('image/png', 1.0);
        link.click();
        
        // إعادة زر التحميل إلى حالته الأصلية
        downloadBtn.innerHTML = originalText;
        downloadBtn.disabled = false;
      }).catch(error => {
        console.error('Error generating image:', error);
        alert('حدث خطأ أثناء تحميل الصورة');
        downloadBtn.innerHTML = originalText;
        downloadBtn.disabled = false;
      });
    }

    // تحميل PDF من الـ modal
    function downloadPDFFromModal() {
      const previewContent = document.getElementById('previewTemplateContent');
      
      // إظهار رسالة تحميل
      const downloadBtn = event.target;
      const originalText = downloadBtn.innerHTML;
      downloadBtn.innerHTML = 'جاري التحميل...';
      downloadBtn.disabled = true;

      html2canvas(previewContent, {
        backgroundColor: '#ffffff',
        scale: 2,
        useCORS: true,
        logging: false
      }).then((canvas) => {
        const imgData = canvas.toDataURL('image/jpeg', 0.9);
        const pdf = new jspdf.jsPDF('p', 'mm', 'a4');
        const imgWidth = 190;
        const pageHeight = 280;
        const imgHeight = (canvas.height * imgWidth) / canvas.width;
        
        let heightLeft = imgHeight;
        let position = 10;

        // الصفحة الأولى
        pdf.addImage(imgData, 'JPEG', 10, position, imgWidth, imgHeight);
        heightLeft -= pageHeight;

        // إضافة صفحات إضافية إذا كان المحتوى طويلاً
        while (heightLeft >= 0) {
          position = heightLeft - imgHeight + 10;
          pdf.addPage();
          pdf.addImage(imgData, 'JPEG', 10, position, imgWidth, imgHeight);
          heightLeft -= pageHeight;
        }

        pdf.save(`تقرير-تنفيذ-برنامج-${new Date().toLocaleDateString('ar-SA')}.pdf`);
        
        // إعادة زر التحميل إلى حالته الأصلية
        downloadBtn.innerHTML = originalText;
        downloadBtn.disabled = false;
      }).catch(error => {
        console.error('Error generating PDF:', error);
        alert('حدث خطأ أثناء تحميل PDF');
        downloadBtn.innerHTML = originalText;
        downloadBtn.disabled = false;
      });
    }

    // دالة المعاينة الرئيسية
    function previewTemplate() {
      // التحقق من صحة البيانات أولاً
      if (!validateForm()) {
        // التمرير إلى أول حقل به خطأ
        const firstError = document.querySelector('.field-error');
        if (firstError) {
          firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
        return;
      }

      // إذا كانت البيانات صحيحة، حفظها وفتح المعاينة
      saveFormData();
      generatePreviewContent();
      openPreviewModal();
    }

    // تهيئة الأحداث عند تحميل الصفحة
    document.addEventListener('DOMContentLoaded', function() {
      // تهيئة التحقق من الحقول
      setupFieldValidation();

      // ربط زر المعاينة
      document.getElementById('previewBtn').addEventListener('click', previewTemplate);

      // ربط زر إغلاق الـ modal
      document.getElementById('closeModal').addEventListener('click', closePreviewModal);

      // إغلاق الـ modal عند الضغط خارج المحتوى
      document.getElementById('previewModal').addEventListener('click', function(e) {
        if (e.target === this) {
          closePreviewModal();
        }
      });

      // إغلاق الـ modal عند الضغط على ESC
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
          closePreviewModal();
        }
      });

      // تحميل البيانات المحفوظة إن وجدت
      const savedData = JSON.parse(localStorage.getItem('programReportData') || '{}');
      Object.keys(savedData).forEach(key => {
        const field = document.getElementById(key);
        if (field) {
          field.value = savedData[key];
        }
      });

      // إعادة تعيين النموذج
      document.querySelector('button[type="reset"]').addEventListener('click', function() {
        // إزالة رسائل الخطأ
        document.querySelectorAll('.error-message').forEach(error => {
          error.classList.remove('show');
        });
        document.querySelectorAll('.field-error').forEach(field => {
          field.classList.remove('field-error');
        });
        
        // مسح localStorage
        localStorage.removeItem('programReportData');
      });
    });
  </script>
</body>
</html>
