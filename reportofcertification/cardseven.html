<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ملحق شواهد - edu-forms replica</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Add required libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    crossorigin="anonymous" referrerpolicy="no-referrer">

  <!-- small extra styles to match screenshot look -->
  <style>
    /* subtle page background */
    body {
      background: #f5f6f7;
      font-family: "Tahoma", Arial, sans-serif;
      color: #222;
      padding-top: 100px;
    }

    /* circular preview image */
    .circle-img {
      width: 140px;
      height: 140px;
      border-radius: 9999px;
      overflow: hidden;
      display: inline-block;
      border: 6px solid #ffffff;
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.06);
      background: #fff;
    }

    .footer-ink {
      background: #f8fafb;
    }

    .social-icon {
      width: 26px;
      height: 26px;
      fill: currentColor;
    }


    .circle-img img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    /* dashed top-of-form divider */
    .dashed-top {
      border-top: 1px dashed #e6e9ee;
      padding-top: 18px;
      margin-top: 18px;
    }

    /* file input custom */
    .file-input {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .file-input input[type="file"] {
      display: none;
    }

    .file-btn {
      background: #fff;
      border: 1px solid #d1d5db;
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
    }

    .file-name {
      flex: 1;
      background: #f3f4f6;
      border: 1px solid #e6e9ee;
      padding: 8px 10px;
      border-radius: 8px;
      font-size: 13px;
      color: #666;
    }

    /* small green button exact height */
    .btn-green {
      background: #19a34a;
      color: white;
    }

    /* footer stat boxes style */
    .stat-box {
      background: #fff;
      border: 1px solid #e6e9ee;
      border-radius: 8px;
      padding: 18px;
      text-align: center;
    }

    /* breadcrumb thin divider spacing */
    .breadcrumb {
      font-size: 13px;
      color: #4b5563;
    }

    /* Error Styles */
    .error-message {
      color: #dc2626;
      font-size: 11px;
      margin-top: 4px;
      display: none;
    }

    .error-message.show {
      display: block;
    }

    .field-error {
      border-color: #dc2626 !important;
      border-width: 2px !important;
    }

    /* Modal Styles */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.7);
      z-index: 1000;
      overflow-y: auto;
      padding: 20px;
    }

    .modal-overlay.active {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-content {
      background: white;
      border-radius: 16px;
      max-width: 90%;
      width: 100%;
      max-width: 800px;
      position: relative;
      margin: auto;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px;
      border-bottom: 1px solid #e5e7eb;
    }

    .modal-body {
      padding: 20px;
      max-height: calc(100vh - 200px);
      overflow-y: auto;
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 28px;
      cursor: pointer;
      color: #6b7280;
      padding: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: all 0.2s;
    }

    .modal-close:hover {
      background-color: #f3f4f6;
      color: #111827;
    }

    .preview-template {
      background: white;
      padding: 30px;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
    }

    /* Download Buttons */
    .download-buttons {
      display: flex;
      justify-content: center;
      gap: 12px;
      margin-top: 20px;
      flex-wrap: wrap;
    }

    .btn-download {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.3s;
    }

    .btn-download-pdf {
      background: #dc2626;
      color: white;
    }

    .btn-download-pdf:hover {
      background: #b91c1c;
    }

    .btn-download-image {
      background: #2563eb;
      color: white;
    }

    .btn-download-image:hover {
      background: #1d4ed8;
    }

    .btn-close {
      background: #6b7280;
      color: white;
    }

    .btn-close:hover {
      background: #4b5563;
    }

    /* responsive tweaks */
    @media (max-width: 768px) {
      .circle-img {
        width: 110px;
        height: 110px;
      }

      .download-buttons {
        flex-direction: column;
        align-items: center;
      }

      .btn-download {
        width: 200px;
        justify-content: center;
      }
    }
  </style>
</head>

<body class="antialiased">

  <!-- NAVBAR WITHOUT CART -->
  <header class="fixed inset-x-0 top-4 z-50 px-4 sm:px-6">
    <div class="max-w-6xl mx-auto relative">
      <div class="nav-pill px-3 py-2 flex items-center justify-between gap-3">
        <!-- LOGO -->
        <div class="flex items-center gap-4 ml-2">
          <a href="#" class="shrink-0">
            <img src="../assets/imgs/gsoor_logo.jpg" alt="logo" class="h-9 w-auto object-contain md:h-10" />
          </a>
        </div>

        <!-- NAV LINKS (desktop) -->
        <nav class="hidden md:flex items-center gap-8 text-sm text-gray-700">
          <a href="#" class="hover:text-cyan-600 transition">الشهادات</a>
          <a href="#" class="hover:text-cyan-600 transition">الملفات الإدارية</a>
          <a href="#" class="hover:text-cyan-600 transition">البطاقات</a>
        </nav>

        <!-- UTILITY ICONS WITHOUT CART -->
        <div class="flex items-center gap-2">
          <div class="hidden sm:flex items-center bg-gray-50 rounded-full px-2 py-1 gap-2 border border-gray-100">
            <button id="themeToggle" class="text-gray-600" title="تبديل الوضع">
              <i class="fa-solid fa-moon text-gray-600 text-base"></i>
            </button>
            <button id="profileBtn" class="text-gray-600" title="الحساب">
              <i class="fa-regular fa-user text-gray-600 text-base"></i>
            </button>
          </div>

          <!-- MOBILE MENU BUTTON -->
          <button id="menuBtn" class="md:hidden text-gray-600 p-2" aria-expanded="false">
            <i class="fa-solid fa-bars text-lg"></i>
          </button>
        </div>
      </div>

      <!-- MOBILE NAV WITHOUT CART -->
      <div id="mobileNav" class="hidden mobile-nav-abs mt-2 bg-white rounded-2xl shadow-md p-3 mx-4">
        <div class="flex flex-col gap-2 text-right">
          <a href="#" class="py-2 px-3 rounded hover:bg-gray-50 transition">الشهادات</a>
          <a href="#" class="py-2 px-3 rounded hover:bg-gray-50 transition">الملفات الإدارية</a>
          <a href="#" class="py-2 px-3 rounded hover:bg-gray-50 transition">البطاقات</a>
          <div class="pt-2 border-t border-gray-100 mt-2 flex justify-between items-center">
            <div class="flex items-center gap-3">
              <button id="mobileThemeToggle" class="text-gray-600">
                <i class="fa-solid fa-moon"></i>
              </button>
            </div>
            <a href="#" class="text-sm text-cyan-600 font-semibold">تسجيل دخول</a>
          </div>
        </div>
      </div>
    </div>
  </header>
  <script>
    // NAVBAR FUNCTIONALITY WITHOUT CART
    document.addEventListener('DOMContentLoaded', function () {
      const menuBtn = document.getElementById("menuBtn");
      const mobileNav = document.getElementById("mobileNav");
      const mobileThemeToggle = document.getElementById("mobileThemeToggle");

      // Mobile menu toggle
      if (menuBtn) {
        menuBtn.addEventListener("click", (e) => {
          const expanded = menuBtn.getAttribute("aria-expanded") === "true";
          menuBtn.setAttribute("aria-expanded", String(!expanded));
          mobileNav.classList.toggle("hidden");
        });
      }

      // Close mobile menu when clicking outside
      document.addEventListener("click", (e) => {
        if (!mobileNav || mobileNav.classList.contains("hidden")) return;
        const path = e.composedPath?.() || e.path || [];
        if (!path.includes(mobileNav) && !path.includes(menuBtn)) {
          mobileNav.classList.add("hidden");
          if (menuBtn) menuBtn.setAttribute("aria-expanded", "false");
        }
      });

      // Close mobile menu on window resize
      window.addEventListener("resize", () => {
        if (window.innerWidth >= 768) {
          mobileNav.classList.add("hidden");
          if (menuBtn) menuBtn.setAttribute("aria-expanded", "false");
        }
      });

      // Theme toggle
      document.getElementById("themeToggle")?.addEventListener("click", () => {
        document.documentElement.classList.toggle("dark");
      });

      if (mobileThemeToggle) {
        mobileThemeToggle.addEventListener("click", () => {
          document.documentElement.classList.toggle("dark");
        });
      }
    });
  </script>

  <!-- main card -->
  <main class="max-w-5xl mx-auto px-4 sm:px-6 mt-8">
    <article class="bg-white border border-gray-200 rounded-lg shadow-sm">
      <div class="px-6 py-7">

        <!-- circular image centered -->
        <div class="flex justify-center -mt-10">
          <div class="circle-img">
            <!-- replace src with your image -->
            <img src="/mnt/data/Screenshot_26-11-2025_14758_edu-forms.com.jpeg" alt="preview">
          </div>
        </div>

        <!-- title + description -->
        <header class="text-center mt-4">
          <h1 class="text-2xl font-semibold">ملحق شواهد (شواهد إضافية لأي تقرير)</h1>
          <p class="text-gray-600 mt-3 max-w-3xl mx-auto leading-relaxed">
            إنشاء وتخصيص ملحق شواهد (شواهد إضافية لأي تقرير) مع إمكانية تحرير وإضافة جميع البيانات الخاصة بك،
            بطريقة سهلة واحترافية توفر عليك الوقت والجهد ويتم حفظ الملف النهائي بتنسيق صورة أو pdf لسهولة الطباعة وإعادة
            الاستخدام.
          </p>
        </header>

        <!-- form -->
        <form class="mt-6" id="evidenceForm">
          <!-- container box like screenshot -->
          <div class="bg-white border border-gray-200 rounded-md p-5">

            <!-- row: education area -->
            <div class="mb-4">
              <label class="block text-sm font-medium text-gray-700 mb-2">إدارة التعليم، المنطقة، مكتب التعليم:</label>
              <input name="edu_office" id="eduOffice"
                class="w-full bg-gray-50 border border-gray-200 rounded-md px-3 py-2 text-sm"
                placeholder="الإدارة العامة للتعليم / المنطقة / مكتب التعليم">
              <div id="eduOfficeError" class="error-message">هذا الحقل مطلوب</div>
            </div>

            <!-- title and twitter -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
              <div class="md:col-span-2">
                <label class="block text-sm font-medium text-gray-700 mb-2">العنوان:</label>
                <input name="title" id="title"
                  class="w-full bg-gray-50 border border-gray-200 rounded-md px-3 py-2 text-sm"
                  placeholder="ملحق شواهد برنامج ...">
                <div id="titleError" class="error-message">هذا الحقل مطلوب</div>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">حساب تويتر:</label>
                <input name="twitter" id="twitter"
                  class="w-full bg-gray-50 border border-gray-200 rounded-md px-3 py-2 text-sm" placeholder="@username">
              </div>
            </div>

            <!-- file upload grid - 6 file inputs -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
              <!-- left column: first, third, fifth -->
              <div class="space-y-4">
                <div>
                  <label class="block text-sm text-gray-700 mb-2">صورة الشاهد الأول:</label>
                  <div class="file-input">
                    <span class="file-name">لم يتم اختيار ملف</span>
                    <label class="file-btn" for="file1">اختيار ملف</label>
                    <input id="file1" type="file" accept="image/*" onchange="updateFileName(this)">
                  </div>
                  <div id="file1Error" class="error-message">هذا الحقل مطلوب (يجب رفع شاهد واحد على الأقل)</div>
                </div>

                <div>
                  <label class="block text-sm text-gray-700 mb-2">صورة الشاهد الثالث:</label>
                  <div class="file-input">
                    <span class="file-name">لم يتم اختيار ملف</span>
                    <label class="file-btn" for="file3">اختيار ملف</label>
                    <input id="file3" type="file" accept="image/*" onchange="updateFileName(this)">
                  </div>
                </div>

                <div>
                  <label class="block text-sm text-gray-700 mb-2">صورة الشاهد الخامس:</label>
                  <div class="file-input">
                    <span class="file-name">لم يتم اختيار ملف</span>
                    <label class="file-btn" for="file5">اختيار ملف</label>
                    <input id="file5" type="file" accept="image/*" onchange="updateFileName(this)">
                  </div>
                </div>
              </div>

              <!-- right column: second, fourth, sixth -->
              <div class="space-y-4">
                <div>
                  <label class="block text-sm text-gray-700 mb-2">صورة الشاهد الثاني:</label>
                  <div class="file-input">
                    <span class="file-name">لم يتم اختيار ملف</span>
                    <label class="file-btn" for="file2">اختيار ملف</label>
                    <input id="file2" type="file" accept="image/*" onchange="updateFileName(this)">
                  </div>
                </div>

                <div>
                  <label class="block text-sm text-gray-700 mb-2">صورة الشاهد الرابع:</label>
                  <div class="file-input">
                    <span class="file-name">لم يتم اختيار ملف</span>
                    <label class="file-btn" for="file4">اختيار ملف</label>
                    <input id="file4" type="file" accept="image/*" onchange="updateFileName(this)">
                  </div>
                </div>

                <div>
                  <label class="block text-sm text-gray-700 mb-2">صورة الشاهد السادس:</label>
                  <div class="file-input">
                    <span class="file-name">لم يتم اختيار ملف</span>
                    <label class="file-btn" for="file6">اختيار ملف</label>
                    <input id="file6" type="file" accept="image/*" onchange="updateFileName(this)">
                  </div>
                </div>
              </div>
            </div>

            <!-- Preview button -->
            <div class="mt-5">
              <button type="button" id="previewBtn"
                class="w-full btn-green text-white py-3 rounded-md font-semibold hover:bg-green-600 transition duration-200">معاينة</button>
            </div>

            <!-- helpful links / small buttons -->
            <div class="mt-5 text-center">
              <div class="text-sm text-gray-600 mb-2">أكثر الروابط استخداماً:</div>

              <div class="inline-flex flex-wrap gap-2 justify-center">
                <a class="inline-block px-3 py-2 border border-[#cde3f1] text-[#0b6ea8] rounded-md text-sm bg-white"
                  href="#">أفضل نموذج لتوثيق برنامج أو نشاط (المطوّع)</a>
                <a class="inline-block px-3 py-2 border border-[#cde3f1] text-[#0b6ea8] rounded-md text-sm bg-white"
                  href="#">نموذج تنفيذ استراتيجية مختصرة</a>
                <a class="inline-block px-3 py-2 border border-[#cde3f1] text-[#0b6ea8] rounded-md text-sm bg-white"
                  href="#">تقرير جاهز لليوم العالمي للفيزياء</a>
                <a class="inline-block px-3 py-2 border border-[#cde3f1] text-[#0b6ea8] rounded-md text-sm bg-white"
                  href="#">خطط علاجية وإثرائية</a>
              </div>
            </div>

          </div> <!-- end form container box -->
        </form>


      </div> <!-- px-6 py-7 -->
    </article>
  </main>

  <!-- FOOTER -->
  <footer class="mt-12 footer-ink border-t border-gray-100">
    <div class="max-w-6xl mx-auto px-6 py-8 flex flex-col md:flex-row md:items-center md:justify-between gap-6">
      <!-- RIGHT COLUMN -->
      <div class="text-right md:flex-1">
        <img src="../assets/imgs/gsoor_logo.jpg" alt="logo" class="h-10 mx-auto md:mx-0" />
        <div class="flex justify-center md:justify-end gap-4 mt-3 text-gray-600">
          <i class="fa-brands fa-youtube social-icon text-lg"></i>
          <i class="fa-brands fa-tiktok social-icon text-lg"></i>
          <i class="fa-brands fa-instagram social-icon text-lg"></i>
        </div>
      </div>

      <!-- CENTER COLUMN -->
      <div class="text-center md:flex-1">
        <h3 class="font-bold mb-2">تواصل معنا</h3>
        <div class="flex items-center justify-center gap-4 text-gray-600">
          <div class="flex items-center gap-2">
            <i class="fa-regular fa-envelope text-sm"></i>
            <span>البريد</span>
          </div>
          <div class="flex items-center gap-2">
            <i class="fa-solid fa-mobile-screen-button text-sm"></i>
            <span>واتس</span>
          </div>
        </div>
        <div class="mt-3 text-sm text-gray-500">موقّع لدى منصة الأعمال</div>
      </div>

      <!-- LEFT COLUMN -->
      <div class="text-left md:flex-1">
        <div class="text-sm text-gray-500">
          © 2025 متجر جسور الرقمي | جميع الحقوق محفوظة
        </div>
        <div class="mt-3 flex gap-2 items-center justify-center md:justify-start">
          <span class="sr-only">Visa</span>
          <i class="fa-brands fa-cc-visa text-gray-600 text-lg"></i>
          <span class="sr-only">Mada</span>
          <i class="fa-solid fa-credit-card text-gray-600 text-lg"></i>
        </div>
      </div>
    </div>
  </footer>

  <!-- Modal Popup للمعاينة -->
  <div id="previewModal" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="text-2xl font-bold text-gray-800">معاينة ملحق الشواهد</h2>
        <button class="modal-close" id="closeModal">&times;</button>
      </div>
      <div class="modal-body">
        <div id="previewTemplateContent" class="preview-template">
          <!-- سيتم ملء المحتوى ديناميكياً -->
        </div>
        <div class="download-buttons">
          <button onclick="downloadImageFromModal()" class="btn-download btn-download-image">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
              <path
                d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z" />
              <path
                d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z" />
            </svg>
            تحميل كصورة
          </button>
          <button onclick="downloadPDFFromModal()" class="btn-download btn-download-pdf">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
              <path
                d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z" />
              <path
                d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z" />
            </svg>
            تحميل PDF
          </button>
          <button onclick="closePreviewModal()" class="btn-download btn-close">
            إغلاق
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // تهيئة التحقق من الحقول
    function setupFieldValidation() {
      const textFields = ['eduOffice', 'title'];

      // معالجة حقول النص
      textFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
          field.addEventListener('input', function () {
            this.classList.remove('field-error');
            const errorId = fieldId + 'Error';
            const error = document.getElementById(errorId);
            if (error) {
              error.classList.remove('show');
            }
          });
        }
      });

      // معالجة حقول الملفات
      const fileFields = ['file1', 'file2', 'file3', 'file4', 'file5', 'file6'];
      fileFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
          field.addEventListener('change', function () {
            this.classList.remove('field-error');
            const errorId = fieldId + 'Error';
            const error = document.getElementById(errorId);
            if (error) {
              error.classList.remove('show');
            }
          });
        }
      });
    }

    // دالة التحقق من صحة البيانات
    function validateForm() {
      let isValid = true;

      // إزالة رسائل الخطأ السابقة
      document.querySelectorAll('.error-message').forEach(error => {
        error.classList.remove('show');
      });
      document.querySelectorAll('.field-error').forEach(field => {
        field.classList.remove('field-error');
      });

      // التحقق من الحقول النصية المطلوبة
      const requiredFields = ['eduOffice', 'title'];

      requiredFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field && !field.value.trim()) {
          showError(fieldId, fieldId + 'Error');
          isValid = false;
        }
      });

      // التحقق من صورة الشاهد الأول (مطلوب على الأقل شاهد واحد)
      const witness1 = document.getElementById('file1').files[0];
      if (!witness1) {
        showError('file1', 'file1Error');
        isValid = false;
      }

      return isValid;
    }

    // دالة لإظهار رسالة الخطأ
    function showError(fieldId, errorId) {
      const field = document.getElementById(fieldId);
      const error = document.getElementById(errorId);
      if (field) {
        field.classList.add('field-error');
      }
      if (error) {
        error.classList.add('show');
      }
    }

    // دالة حفظ البيانات
    function saveFormData() {
      const formData = {
        eduOffice: document.getElementById('eduOffice').value,
        title: document.getElementById('title').value,
        twitter: document.getElementById('twitter').value
      };

      localStorage.setItem('evidenceAttachmentData', JSON.stringify(formData));
      return formData;
    }

    // دالة توليد محتوى المعاينة
    function generatePreviewContent() {
      const data = JSON.parse(localStorage.getItem('evidenceAttachmentData') || '{}');
      const previewContainer = document.getElementById('previewTemplateContent');

      // حساب عدد الشواهد المرفوعة
      const fileInputs = ['file1', 'file2', 'file3', 'file4', 'file5', 'file6'];
      let uploadedCount = 0;
      fileInputs.forEach(fileId => {
        if (document.getElementById(fileId).files[0]) {
          uploadedCount++;
        }
      });

      let html = `
        <div class="space-y-6 text-right" id="previewContent">
          <div class="text-center mb-6">
            <h2 class="text-2xl font-bold text-green-800 mb-4">ملحق شواهد (شواهد إضافية لأي تقرير)</h2>
          </div>

          <div class="grid grid-cols-1 gap-4">
            <div><strong>إدارة التعليم، المنطقة، مكتب التعليم:</strong> ${data.eduOffice || ''}</div>
            <div><strong>العنوان:</strong> ${data.title || ''}</div>
            ${data.twitter ? `<div><strong>حساب تويتر:</strong> ${data.twitter}</div>` : ''}
          </div>

          <div class="mt-6 p-4 bg-yellow-50 border border-yellow-200 rounded">
            <strong>ملاحظة:</strong> تم رفع ${uploadedCount} صور للشواهد الإضافية وسيتم عرضها في النسخة النهائية
          </div>

          <div class="mt-4 text-sm text-gray-600">
            <p>هذا الملحق يحتوي على شواهد إضافية يمكن إرفاقها مع أي تقرير لتوثيق البرامج والأنشطة.</p>
          </div>
        </div>
      `;

      previewContainer.innerHTML = html;
    }

    // فتح الـ modal
    function openPreviewModal() {
      const modal = document.getElementById('previewModal');
      modal.classList.add('active');
      document.body.style.overflow = 'hidden';
    }

    // إغلاق الـ modal
    function closePreviewModal() {
      const modal = document.getElementById('previewModal');
      modal.classList.remove('active');
      document.body.style.overflow = 'auto';
    }

    // تحميل الصورة من الـ modal
    function downloadImageFromModal() {
      const previewContent = document.getElementById('previewTemplateContent');

      // إظهار رسالة تحميل
      const downloadBtn = event.target;
      const originalText = downloadBtn.innerHTML;
      downloadBtn.innerHTML = 'جاري التحميل...';
      downloadBtn.disabled = true;

      html2canvas(previewContent, {
        backgroundColor: '#ffffff',
        scale: 2,
        useCORS: true,
        logging: false
      }).then((canvas) => {
        const link = document.createElement('a');
        link.download = `ملحق-شواهد-${new Date().toLocaleDateString('ar-SA')}.png`;
        link.href = canvas.toDataURL('image/png', 1.0);
        link.click();

        // إعادة زر التحميل إلى حالته الأصلية
        downloadBtn.innerHTML = originalText;
        downloadBtn.disabled = false;
      }).catch(error => {
        console.error('Error generating image:', error);
        alert('حدث خطأ أثناء تحميل الصورة');
        downloadBtn.innerHTML = originalText;
        downloadBtn.disabled = false;
      });
    }

    // تحميل PDF من الـ modal
    function downloadPDFFromModal() {
      const previewContent = document.getElementById('previewTemplateContent');

      // إظهار رسالة تحميل
      const downloadBtn = event.target;
      const originalText = downloadBtn.innerHTML;
      downloadBtn.innerHTML = 'جاري التحميل...';
      downloadBtn.disabled = true;

      html2canvas(previewContent, {
        backgroundColor: '#ffffff',
        scale: 2,
        useCORS: true,
        logging: false
      }).then((canvas) => {
        const imgData = canvas.toDataURL('image/jpeg', 0.9);
        const pdf = new jspdf.jsPDF('p', 'mm', 'a4');
        const imgWidth = 190;
        const pageHeight = 280;
        const imgHeight = (canvas.height * imgWidth) / canvas.width;

        let heightLeft = imgHeight;
        let position = 10;

        // الصفحة الأولى
        pdf.addImage(imgData, 'JPEG', 10, position, imgWidth, imgHeight);
        heightLeft -= pageHeight;

        // إضافة صفحات إضافية إذا كان المحتوى طويلاً
        while (heightLeft >= 0) {
          position = heightLeft - imgHeight + 10;
          pdf.addPage();
          pdf.addImage(imgData, 'JPEG', 10, position, imgWidth, imgHeight);
          heightLeft -= pageHeight;
        }

        pdf.save(`ملحق-شواهد-${new Date().toLocaleDateString('ar-SA')}.pdf`);

        // إعادة زر التحميل إلى حالته الأصلية
        downloadBtn.innerHTML = originalText;
        downloadBtn.disabled = false;
      }).catch(error => {
        console.error('Error generating PDF:', error);
        alert('حدث خطأ أثناء تحميل PDF');
        downloadBtn.innerHTML = originalText;
        downloadBtn.disabled = false;
      });
    }

    // دالة المعاينة الرئيسية
    function previewTemplate() {
      // التحقق من صحة البيانات أولاً
      if (!validateForm()) {
        // التمرير إلى أول حقل به خطأ
        const firstError = document.querySelector('.field-error');
        if (firstError) {
          firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
        return;
      }

      // إذا كانت البيانات صحيحة، حفظها وفتح المعاينة
      saveFormData();
      generatePreviewContent();
      openPreviewModal();
    }

    // small script: update file name display
    function updateFileName(input) {
      const label = input.closest('.file-input').querySelector('.file-name');
      const file = input.files && input.files[0];
      label.textContent = file ? file.name : 'لم يتم اختيار ملف';
    }

    // تهيئة الأحداث عند تحميل الصفحة
    document.addEventListener('DOMContentLoaded', function () {
      // تهيئة التحقق من الحقول
      setupFieldValidation();

      // ربط زر المعاينة
      document.getElementById('previewBtn').addEventListener('click', previewTemplate);

      // ربط زر إغلاق الـ modal
      document.getElementById('closeModal').addEventListener('click', closePreviewModal);

      // إغلاق الـ modal عند الضغط خارج المحتوى
      document.getElementById('previewModal').addEventListener('click', function (e) {
        if (e.target === this) {
          closePreviewModal();
        }
      });

      // إغلاق الـ modal عند الضغط على ESC
      document.addEventListener('keydown', function (e) {
        if (e.key === 'Escape') {
          closePreviewModal();
        }
      });

      // hook the hidden file labels to open file picker
      document.querySelectorAll('.file-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const id = btn.getAttribute('for');
          if (id) {
            document.getElementById(id).click();
          }
        });
      });

      // تحميل البيانات المحفوظة إن وجدت
      const savedData = JSON.parse(localStorage.getItem('evidenceAttachmentData') || '{}');
      Object.keys(savedData).forEach(key => {
        const field = document.getElementById(key);
        if (field) {
          field.value = savedData[key];
        }
      });
    });
  </script>
</body>

</html>
